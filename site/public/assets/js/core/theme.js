(function(){'use strict';const log=window.BengalUtils?.log||(()=>{});const THEME_KEY='bengal-theme';const PALETTE_KEY='bengal-palette';const THEMES={SYSTEM:'system',LIGHT:'light',DARK:'dark'};function getTheme(){const stored=localStorage.getItem(THEME_KEY);if(stored&&stored!==THEMES.SYSTEM){return stored;}
if(window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches){return THEMES.DARK;}
return THEMES.LIGHT;}
function setTheme(theme){const resolved=theme===THEMES.SYSTEM?getTheme():theme;document.documentElement.setAttribute('data-theme',resolved);localStorage.setItem(THEME_KEY,theme);window.dispatchEvent(new CustomEvent('themechange',{detail:{theme:resolved}}));}
function updateResolvedTheme(){const stored=localStorage.getItem(THEME_KEY);if(stored===THEMES.SYSTEM||!stored){const resolved=getTheme();document.documentElement.setAttribute('data-theme',resolved);window.dispatchEvent(new CustomEvent('themechange',{detail:{theme:resolved}}));}}
function getPalette(){return localStorage.getItem(PALETTE_KEY)||'';}
function setPalette(palette){if(palette!==null){if(palette){document.documentElement.setAttribute('data-palette',palette);}else{document.documentElement.removeAttribute('data-palette');}
localStorage.setItem(PALETTE_KEY,palette);}else{document.documentElement.removeAttribute('data-palette');localStorage.removeItem(PALETTE_KEY);}
window.dispatchEvent(new CustomEvent('palettechange',{detail:{palette}}));}
function toggleTheme(){const stored=localStorage.getItem(THEME_KEY)||THEMES.SYSTEM;const current=stored===THEMES.SYSTEM?getTheme():stored;const next=current===THEMES.LIGHT?THEMES.DARK:THEMES.LIGHT;setTheme(next);}
function initTheme(){const stored=localStorage.getItem(THEME_KEY)||THEMES.SYSTEM;setTheme(stored);const palette=getPalette();if(palette)setPalette(palette);}
function setupToggleButton(){const toggleBtn=document.querySelector('.theme-toggle');if(toggleBtn){toggleBtn.addEventListener('click',toggleTheme);toggleBtn.addEventListener('keydown',function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();toggleTheme();}});}}
function setupPopoverMenus(){const popoverMenus=document.querySelectorAll('.theme-dropdown__menu--popover[popover]');popoverMenus.forEach(function(menu){const triggerId=menu.id;const triggerBtn=triggerId?document.querySelector('[popovertarget="'+triggerId+'"]'):menu.previousElementSibling;menu.addEventListener('click',function(e){const btn=e.target.closest('.theme-option, [data-appearance], [data-palette]');if(!btn)return;const appearance=btn.getAttribute('data-appearance');const palette=btn.getAttribute('data-palette');if(appearance){setTheme(appearance);}
if(palette!==null&&palette!==undefined){setPalette(palette);}
updatePopoverActiveStates(menu);if(menu.hidePopover){menu.hidePopover();}});menu.addEventListener('toggle',function(e){if(e.newState==='open'){positionPopover(menu,triggerBtn);updatePopoverActiveStates(menu);}});updatePopoverActiveStates(menu);});}
function positionPopover(popover,trigger){if(!trigger)return;const triggerRect=trigger.getBoundingClientRect();const popoverRect=popover.getBoundingClientRect();const viewportWidth=window.innerWidth;let top=triggerRect.bottom+8;let right=viewportWidth-triggerRect.right;const left=viewportWidth-right-popoverRect.width;if(left<8){right=viewportWidth-popoverRect.width-8;}
popover.style.top=top+'px';popover.style.right=right+'px';popover.style.left='auto';}
function updatePopoverActiveStates(menu){const currentAppearance=localStorage.getItem(THEME_KEY)||THEMES.SYSTEM;const currentPalette=getPalette();menu.querySelectorAll('[data-appearance]').forEach(function(btn){const appearance=btn.getAttribute('data-appearance');btn.classList.toggle('active',appearance===currentAppearance);});menu.querySelectorAll('[data-palette]').forEach(function(btn){const palette=btn.getAttribute('data-palette');btn.classList.toggle('active',palette===currentPalette);});}
function watchSystemTheme(){if(window.matchMedia){const mediaQuery=window.matchMedia('(prefers-color-scheme: dark)');mediaQuery.addEventListener('change',function(){if((localStorage.getItem(THEME_KEY)||THEMES.SYSTEM)===THEMES.SYSTEM){updateResolvedTheme();}});}}
window.BengalTheme={get:getTheme,set:setTheme,toggle:toggleTheme,getPalette:getPalette,setPalette:setPalette};if(window.Bengal&&window.Bengal.enhance){Bengal.enhance.register('theme-toggle',function(el,options){el.addEventListener('click',function(e){e.preventDefault();toggleTheme();});el.addEventListener('keydown',function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();toggleTheme();}});if(el.tagName!=='BUTTON'){el.setAttribute('role','button');el.setAttribute('tabindex','0');}},{override:true});}
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',function(){initTheme();setupToggleButton();setupPopoverMenus();watchSystemTheme();});}else{initTheme();setupToggleButton();setupPopoverMenus();watchSystemTheme();}
log('[BengalTheme] Initialized');})();