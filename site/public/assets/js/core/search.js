(function(){'use strict';if(!window.BengalUtils){console.error('[Bengal] utils.js required for search');return;}
const{log,escapeRegex,ready,debounce}=window.BengalUtils;const CONFIG={indexUrl:null,prebuiltIndexUrl:null,minQueryLength:2,maxResults:50,excerptLength:150,highlightClass:'search-highlight',debounceDelay:200,usePrebuilt:true,maxRecentSearches:5,modalDebounceDelay:150,storageKey:'bengal-recent-searches',};let searchIndex=null;let searchData=null;let isIndexLoaded=false;let isIndexLoading=false;let currentFilters={section:null,type:null,tags:[],author:null,};let modal=null;let modalInput=null;let resultsList=null;let recentSection=null;let recentList=null;let noResults=null;let emptyState=null;let loading=null;let status=null;let isModalOpen=false;let selectedIndex=-1;let currentResults=[];let recentSearches=[];let preloadTriggered=false;function resolveBaseUrl(){let baseurl='';try{const m=document.querySelector('meta[name="bengal:baseurl"]');baseurl=(m&&m.getAttribute('content'))||'';}catch(e){}
return baseurl.replace(/\/$/,'');}
function buildIndexUrl(filename,baseurl){let url='/'+filename;if(baseurl){url=baseurl+url;}
return url;}
function detectCurrentVersion(){const meta=document.querySelector('meta[name="bengal:version"]');if(meta){return meta.getAttribute('content');}
const match=window.location.pathname.match(/\/docs\/(v\d+)\//);return match?match[1]:null;}
function buildVersionedIndexUrl(baseurl){const version=detectCurrentVersion();if(!version){return buildIndexUrl('index.json',baseurl);}
return buildIndexUrl(`docs/${version}/index.json`,baseurl);}
async function loadSearchIndex(){if(isIndexLoaded||isIndexLoading)return;isIndexLoading=true;try{const baseurl=resolveBaseUrl();if(CONFIG.usePrebuilt){const prebuiltLoaded=await tryLoadPrebuiltIndex(baseurl);if(prebuiltLoaded){isIndexLoaded=true;isIndexLoading=false;window.dispatchEvent(new CustomEvent('searchIndexLoaded',{detail:{pages:searchData.pages.length,prebuilt:true}}));return;}}
await loadAndBuildRuntimeIndex(baseurl);isIndexLoaded=true;isIndexLoading=false;window.dispatchEvent(new CustomEvent('searchIndexLoaded',{detail:{pages:searchData.pages.length,prebuilt:false}}));}catch(error){console.error('Failed to load search index:',error);isIndexLoading=false;window.dispatchEvent(new CustomEvent('searchIndexError',{detail:{error:error.message}}));}}
async function tryLoadPrebuiltIndex(baseurl){try{const metaTag=document.querySelector('meta[name="bengal:search_index_url"]');if(!metaTag){log('Pre-built index not available (lunr not installed)');return false;}
const version=detectCurrentVersion();let prebuiltUrl='';if(version){prebuiltUrl=buildIndexUrl(`docs/${version}/search-index.json`,baseurl);}else{prebuiltUrl=metaTag.getAttribute('content')||'';}
if(!prebuiltUrl){return false;}
const response=await fetch(prebuiltUrl);if(!response.ok){log('Pre-built index not found, falling back to runtime build');return false;}
const prebuiltData=await response.json();if(typeof lunr==='undefined'||!lunr.Index){log('Lunr.js not available for pre-built index');return false;}
searchIndex=lunr.Index.load(prebuiltData);const indexUrl=buildVersionedIndexUrl(baseurl);const dataResponse=await fetch(indexUrl);if(!dataResponse.ok){throw new Error(`Failed to load page data:${dataResponse.status}`);}
const data=await dataResponse.json();if(!data||!Array.isArray(data.pages)){throw new Error('Invalid page data structure');}
searchData=data;log(`Search index loaded(pre-built):${data.pages.length}pages`);return true;}catch(error){log('Pre-built index load failed, falling back to runtime build:',error.message);return false;}}
async function loadAndBuildRuntimeIndex(baseurl){let indexUrl='';try{const m2=document.querySelector('meta[name="bengal:index_url"]');indexUrl=(m2&&m2.getAttribute('content'))||'';}catch(e){}
if(!indexUrl){indexUrl=buildVersionedIndexUrl(baseurl);}
const response=await fetch(indexUrl);if(!response.ok){throw new Error(`Failed to load search index:${response.status}`);}
const data=await response.json();if(!data||typeof data!=='object'){throw new Error('Invalid search index: expected object, got '+typeof data);}
if(!Array.isArray(data.pages)){throw new Error('Invalid search index: missing or invalid "pages" array. Got: '+typeof data.pages);}
searchData=data;searchIndex=lunr(function(){this.ref('objectID');this.field('title',{boost:10});this.field('description',{boost:5});this.field('content',{boost:1});this.field('tags',{boost:3});this.field('section',{boost:2});this.field('author',{boost:2});this.field('search_keywords',{boost:8});this.field('kind',{boost:1});data.pages.forEach(page=>{if(!page.search_exclude&&!page.draft){this.add({objectID:page.objectID||page.href,title:page.title||'',description:page.description||'',content:page.content||page.excerpt||'',tags:(page.tags||[]).join(' '),section:page.section||'',author:page.author||page.authors?.join(' ')||'',search_keywords:(page.search_keywords||[]).join(' '),kind:page.kind||page.type||'',});}});});log(`Search index loaded(runtime):${data.pages.length}pages`);}
function parseQueryTerms(query){const rawTerms=query.trim().toLowerCase().split(/\s+/).filter(Boolean);return rawTerms.map(term=>{const hasOperators=/[*~+\-:]/.test(term);const isExact=term.startsWith('"')&&term.endsWith('"');if(isExact){term=term.slice(1,-1);}
return{term:term,hasOperators:hasOperators,isExact:isExact,isShort:term.length<4};}).filter(t=>t.term.length>0);}
function search(query,filters={}){if(!isIndexLoaded||!searchIndex||!searchData||!Array.isArray(searchData.pages)){console.warn('Search index not loaded');return[];}
if(!query||query.length<CONFIG.minQueryLength){return[];}
try{const parsedTerms=parseQueryTerms(query);if(parsedTerms.length===0){return[];}
let results=searchIndex.query(function(q){parsedTerms.forEach(({term,hasOperators,isExact,isShort})=>{if(hasOperators){q.term(term);return;}
q.term(term,{boost:10,usePipeline:true,presence:lunr.Query.presence.OPTIONAL});if(!isExact){q.term(term,{boost:5,wildcard:lunr.Query.wildcard.TRAILING,usePipeline:true,presence:lunr.Query.presence.OPTIONAL});}
if(!isExact&&!isShort){q.term(term,{boost:1,editDistance:1,usePipeline:true,presence:lunr.Query.presence.OPTIONAL});}});});results=results.map(result=>{const page=searchData.pages.find(p=>(p.objectID||p.uri||p.href)===result.ref);if(page){return{...page,href:page.href||page.uri,score:result.score,matchData:result.matchData,};}
return null;}).filter(Boolean);results=applyFilters(results,filters);results=transformResults(results,query);results=results.slice(0,CONFIG.maxResults);return results;}catch(error){console.error('Search error:',error);return[];}}
function groupResults(results){const groups={};results.forEach(result=>{let groupName='Other';if(result.dir&&result.dir!=='/'){const pathParts=result.dir.split('/').filter(Boolean);if(pathParts.length>0){if(pathParts.length===1){groupName=formatGroupName(pathParts[0]);}else{groupName=formatGroupName(pathParts[pathParts.length-1]);}}}
else if(result.section){groupName=formatGroupName(result.section);}
else if(result.type){groupName=formatGroupName(result.type);}
if(!groups[groupName]){groups[groupName]=[];}
groups[groupName].push(result);});return Object.entries(groups).map(([name,items])=>({name,items,count:items.length})).sort((a,b)=>{if(b.count!==a.count){return b.count-a.count;}
return a.name.localeCompare(b.name);});}
function formatGroupName(name){return name.split('-').map(word=>word.charAt(0).toUpperCase()+word.slice(1)).join(' ');}
function applyFilters(results,filters){let filtered=results;if(filters.section){filtered=filtered.filter(r=>r.section===filters.section);}
if(filters.type){filtered=filtered.filter(r=>r.type===filters.type);}
if(filters.tags&&filters.tags.length>0){filtered=filtered.filter(r=>{const pageTags=r.tags||[];return filters.tags.some(tag=>pageTags.includes(tag));});}
if(filters.author){filtered=filtered.filter(r=>r.author===filters.author||(r.authors&&r.authors.includes(filters.author)));}
if(filters.difficulty){filtered=filtered.filter(r=>r.difficulty===filters.difficulty);}
if(filters.featured){filtered=filtered.filter(r=>r.featured===true);}
return filtered;}
function transformResults(results,query){const queryTerms=query.toLowerCase().split(/\s+/).filter(Boolean);return results.map(result=>{result.highlightedTitle=highlightMatches(result.title,queryTerms);result.highlightedExcerpt=createHighlightedExcerpt(result.content||result.excerpt||result.description,queryTerms,CONFIG.excerptLength);if(result.date){result.formattedDate=formatDate(result.date);}
if(result.section){result.breadcrumb=`${result.section}/${result.title}`;}
if(result.type){result.typeBadge={text:result.type,class:`badge-${result.type}`,};}
return result;});}
function highlightMatches(text,terms){if(!text||!terms.length)return text;const escapedTerms=terms.map(term=>escapeRegex(term)).join('|');const termRegex=new RegExp(`(${escapedTerms})`,'gi');const htmlTagRegex=/<[^>]+>/g;let result='';let lastIndex=0;let match;while((match=htmlTagRegex.exec(text))!==null){const textBefore=text.slice(lastIndex,match.index);if(textBefore){result+=textBefore.replace(termRegex,`<mark class="${CONFIG.highlightClass}">$1</mark>`);}
result+=match[0];lastIndex=htmlTagRegex.lastIndex;}
const remainingText=text.slice(lastIndex);if(remainingText){result+=remainingText.replace(termRegex,`<mark class="${CONFIG.highlightClass}">$1</mark>`);}
return result;}
function createHighlightedExcerpt(text,terms,length){if(!text)return'';let matchPos=-1;terms.forEach(term=>{const pos=text.toLowerCase().indexOf(term.toLowerCase());if(pos!==-1&&(matchPos===-1||pos<matchPos)){matchPos=pos;}});let excerpt;if(matchPos!==-1){const start=Math.max(0,matchPos-Math.floor(length/2));const end=Math.min(text.length,start+length);excerpt=text.substring(start,end);if(start>0)excerpt='...'+excerpt;if(end<text.length)excerpt=excerpt+'...';}else{excerpt=text.substring(0,length);if(text.length>length)excerpt+='...';}
return highlightMatches(excerpt,terms);}
function formatDate(dateStr){try{const date=new Date(dateStr);return date.toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'});}catch(error){return dateStr;}}
function getUniqueValues(field){if(!searchData||!Array.isArray(searchData.pages))return[];const values=new Set();searchData.pages.forEach(page=>{const value=page[field];if(value){if(Array.isArray(value)){value.forEach(v=>values.add(v));}else{values.add(value);}}});return Array.from(values).sort();}
function getAvailableSections(){return getUniqueValues('section');}
function getAvailableTypes(){return getUniqueValues('type');}
function getAvailableTags(){return getUniqueValues('tags');}
function getAvailableAuthors(){const authors=new Set();if(searchData&&Array.isArray(searchData.pages)){searchData.pages.forEach(page=>{if(page.author)authors.add(page.author);if(page.authors)page.authors.forEach(a=>authors.add(a));});}
return Array.from(authors).sort();}
function initModal(){modal=document.getElementById('search-modal');if(!modal){log('Search modal not found - modal disabled in config?');return;}
modalInput=document.getElementById('search-modal-input');resultsList=document.getElementById('search-modal-results-list');recentSection=document.getElementById('search-modal-recent');recentList=document.getElementById('search-modal-recent-list');noResults=document.getElementById('search-modal-no-results');emptyState=document.getElementById('search-modal-empty');loading=document.getElementById('search-modal-loading');status=document.getElementById('search-modal-status');loadRecentSearches();bindModalEvents();log('Search modal initialized');}
function bindModalEvents(){document.addEventListener('keydown',handleGlobalKeydown);modal.addEventListener('keydown',handleModalKeydown);modal.addEventListener('click',handleModalClick);modalInput.addEventListener('input',debounce(handleModalInput,CONFIG.modalDebounceDelay));modalInput.addEventListener('focus',handleInputFocus);document.querySelectorAll('[data-close-modal]').forEach(el=>{el.addEventListener('click',closeModal);});const clearRecentBtn=document.getElementById('clear-recent-searches');if(clearRecentBtn){clearRecentBtn.addEventListener('click',clearRecentSearches);}
const triggers=document.querySelectorAll('#search-trigger, #nav-search-trigger, .nav-search-trigger');triggers.forEach(trigger=>{trigger.addEventListener('click',openModal);});window.addEventListener('searchIndexLoaded',()=>{if(loading)loading.style.display='none';});}
function handleGlobalKeydown(e){if((e.metaKey||e.ctrlKey)&&e.key==='k'){e.preventDefault();if(isModalOpen){modalInput.focus();modalInput.select();}else{openModal();}}
if(e.key==='/'&&!isModalOpen&&!isInputElement(e.target)){e.preventDefault();openModal();}}
function handleModalKeydown(e){switch(e.key){case'Escape':e.preventDefault();closeModal();break;case'ArrowDown':e.preventDefault();navigateResults(1);break;case'ArrowUp':e.preventDefault();navigateResults(-1);break;case'Enter':e.preventDefault();selectResult();break;case'Tab':handleTabKey(e);break;}}
function handleTabKey(e){const focusableElements=modal.querySelectorAll('input, button, [tabindex]:not([tabindex="-1"])');const firstElement=focusableElements[0];const lastElement=focusableElements[focusableElements.length-1];if(e.shiftKey){if(document.activeElement===firstElement){e.preventDefault();lastElement.focus();}}else{if(document.activeElement===lastElement){e.preventDefault();firstElement.focus();}}}
function isInputElement(element){const tagName=element.tagName.toLowerCase();return tagName==='input'||tagName==='textarea'||element.isContentEditable;}
function handleModalInput(e){const query=e.target.value.trim();if(query.length<CONFIG.minQueryLength){hideResults();showRecentSearches();return;}
performModalSearch(query);}
function handleInputFocus(){if(!modalInput.value.trim()){showRecentSearches();}}
function performModalSearch(query){if(!isIndexLoaded){log('Search index not loaded yet');if(loading)loading.style.display='flex';return;}
if(loading)loading.style.display='none';const results=search(query);currentResults=results.slice(0,20);displayModalResults(currentResults,query);updateStatus(`${currentResults.length}results found`);}
function displayModalResults(results,query){hideRecentSearches();hideEmptyState();if(results.length===0){showNoResults(query);return;}
hideNoResults();resultsList.innerHTML='';selectedIndex=-1;const{docs,api}=groupByAutodoc(results);let globalIndex=0;if(docs.length>0){const docsSection=createResultSection('Documentation',docs,query,false,globalIndex);resultsList.appendChild(docsSection);globalIndex+=docs.length;}
if(api.length>0){const apiSection=createResultSection(`API Reference(${api.length})`,api,query,true,globalIndex);resultsList.appendChild(apiSection);}
resultsList.parentElement.style.display='block';}
function groupByAutodoc(results){const docs=[];const api=[];results.forEach(result=>{if(result.isAutodoc){api.push(result);}else{docs.push(result);}});return{docs,api};}
function createResultSection(title,items,query,collapsed,startIndex){const section=document.createElement('div');section.className='search-modal__results-group';const header=document.createElement('div');header.className='search-modal__section-header';if(collapsed){header.classList.add('search-modal__section-header--collapsible');}
header.innerHTML=`<span class="search-modal__section-title">${title}</span>${collapsed?'<span class="search-modal__section-toggle" aria-hidden="true">▶</span>':''}`;const itemsContainer=document.createElement('div');itemsContainer.className='search-modal__section-items';if(collapsed){itemsContainer.style.display='none';itemsContainer.setAttribute('aria-hidden','true');}
items.forEach((result,localIndex)=>{const globalIdx=startIndex+localIndex;const item=createResultItem(result,globalIdx,query);if(result.isAutodoc){const badge=document.createElement('span');badge.className='search-modal__autodoc-badge';badge.textContent='API';const contentEl=item.querySelector('.search-modal__result-content');if(contentEl){contentEl.appendChild(badge);}}
itemsContainer.appendChild(item);});if(collapsed){header.style.cursor='pointer';header.setAttribute('role','button');header.setAttribute('aria-expanded','false');header.setAttribute('tabindex','0');const toggleSection=()=>{const isHidden=itemsContainer.style.display==='none';itemsContainer.style.display=isHidden?'block':'none';itemsContainer.setAttribute('aria-hidden',!isHidden);header.querySelector('.search-modal__section-toggle').textContent=isHidden?'▼':'▶';header.setAttribute('aria-expanded',isHidden);};header.addEventListener('click',toggleSection);header.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();toggleSection();}});}
section.appendChild(header);section.appendChild(itemsContainer);return section;}
function createResultItem(result,index,query){const item=document.createElement('div');item.className='search-modal__result-item';item.setAttribute('role','option');item.setAttribute('aria-selected','false');item.setAttribute('data-index',index);const href=result.href||result.uri;const title=result.highlightedTitle||result.title||'Untitled';const description=result.description||result.highlightedExcerpt||result.excerpt||'';const section=result.section||'';item.innerHTML=`<a href="${href}"class="search-modal__result-link"tabindex="-1"><div class="search-modal__result-content"><span class="search-modal__result-title">${title}</span>${section?`<span class="search-modal__result-section">${section}</span>`:''}</div>${description?`<p class="search-modal__result-excerpt">${description}</p>`:''}</a>`;item.addEventListener('click',(e)=>{e.preventDefault();selectedIndex=index;selectResult();});return item;}
function navigateResults(direction){const items=getNavigableItems();if(items.length===0)return;if(selectedIndex>=0&&selectedIndex<items.length){items[selectedIndex].classList.remove('search-modal__result-item--selected');items[selectedIndex].setAttribute('aria-selected','false');}
selectedIndex+=direction;if(selectedIndex<0)selectedIndex=items.length-1;if(selectedIndex>=items.length)selectedIndex=0;const selectedItem=items[selectedIndex];selectedItem.classList.add('search-modal__result-item--selected');selectedItem.setAttribute('aria-selected','true');selectedItem.scrollIntoView({block:'nearest',behavior:'smooth'});const title=selectedItem.querySelector('.search-modal__result-title');if(title){updateStatus(`${title.textContent},${selectedIndex+1}of ${items.length}`);}}
function selectResult(){const query=modalInput.value.trim();const items=getNavigableItems();if(selectedIndex<0){if(query){goToSearchPage(query);}
return;}
if(selectedIndex>=0&&selectedIndex<items.length){const selectedItem=items[selectedIndex];const link=selectedItem.querySelector('a');if(link){if(query){addRecentSearch(query,link.href,selectedItem.querySelector('.search-modal__result-title')?.textContent||query);}
closeModal();window.location.href=link.href;}}}
function goToSearchPage(query){const baseurl=resolveBaseUrl();const searchUrl=`${baseurl}/search/?q=${encodeURIComponent(query)}`;closeModal();window.location.href=searchUrl;}
function getNavigableItems(){const resultItems=resultsList.querySelectorAll('.search-modal__result-item');const recentItems=recentList.querySelectorAll('.search-modal__recent-item');if(resultItems.length>0){return Array.from(resultItems);}
if(recentSection.style.display!=='none'){return Array.from(recentItems);}
return[];}
function openModal(){if(isModalOpen)return;modal.showModal();isModalOpen=true;selectedIndex=-1;requestAnimationFrame(()=>{modalInput.focus();modalInput.select();});if(!modalInput.value.trim()){showRecentSearches();}
if(!isIndexLoaded){if(loading)loading.style.display='flex';loadSearchIndex();}
document.body.classList.add('search-modal-open');log('Search modal opened');}
function closeModal(){if(!isModalOpen)return;modal.close();isModalOpen=false;selectedIndex=-1;currentResults=[];modalInput.value='';hideResults();showEmptyState();document.body.classList.remove('search-modal-open');log('Search modal closed');}
function loadRecentSearches(){try{const stored=localStorage.getItem(CONFIG.storageKey);recentSearches=stored?JSON.parse(stored):[];}catch(e){recentSearches=[];}}
function saveRecentSearches(){try{localStorage.setItem(CONFIG.storageKey,JSON.stringify(recentSearches));}catch(e){}}
function addRecentSearch(query,href,title){recentSearches=recentSearches.filter(s=>s.query!==query);recentSearches.unshift({query,href,title,timestamp:Date.now()});if(recentSearches.length>CONFIG.maxRecentSearches){recentSearches=recentSearches.slice(0,CONFIG.maxRecentSearches);}
saveRecentSearches();}
function showRecentSearches(){if(recentSearches.length===0){hideRecentSearches();showEmptyState();return;}
hideEmptyState();hideResults();hideNoResults();recentList.innerHTML='';selectedIndex=-1;recentSearches.forEach((search,index)=>{const item=document.createElement('li');item.className='search-modal__recent-item';item.setAttribute('role','option');item.setAttribute('aria-selected','false');item.setAttribute('data-index',index);item.innerHTML=`<a href="${search.href}"class="search-modal__recent-link"tabindex="-1"><svg class="search-modal__recent-icon"width="16"height="16"viewBox="0 0 24 24"fill="none"stroke="currentColor"stroke-width="2"><circle cx="12"cy="12"r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg><span class="search-modal__recent-text">${search.title||search.query}</span></a><button type="button"class="search-modal__recent-remove"data-query="${search.query}"title="Remove from recent"><svg width="14"height="14"viewBox="0 0 24 24"fill="none"stroke="currentColor"stroke-width="2"><line x1="18"y1="6"x2="6"y2="18"></line><line x1="6"y1="6"x2="18"y2="18"></line></svg></button>`;item.querySelector('a').addEventListener('click',(e)=>{closeModal();});item.querySelector('.search-modal__recent-remove').addEventListener('click',(e)=>{e.stopPropagation();removeRecentSearch(search.query);});recentList.appendChild(item);});recentSection.style.display='block';}
function hideRecentSearches(){recentSection.style.display='none';}
function removeRecentSearch(query){recentSearches=recentSearches.filter(s=>s.query!==query);saveRecentSearches();showRecentSearches();}
function clearRecentSearches(){recentSearches=[];saveRecentSearches();showRecentSearches();}
function showNoResults(query){hideResults();const queryEl=document.getElementById('search-modal-no-results-query');if(queryEl)queryEl.textContent=query;noResults.style.display='flex';}
function hideNoResults(){noResults.style.display='none';}
function showEmptyState(){emptyState.style.display='block';}
function hideEmptyState(){emptyState.style.display='none';}
function hideResults(){resultsList.innerHTML='';resultsList.parentElement.style.display='none';selectedIndex=-1;currentResults=[];}
function updateStatus(message){if(status){status.textContent=message;}}
function handleModalClick(e){if(e.target.hasAttribute('data-close-modal')){closeModal();}}
let pageInput=null;let pageClearBtn=null;let pageResults=null;let pageResultsList=null;let pageResultsCount=null;let pageNoResults=null;let pageNoResultsQuery=null;let pageEmptyState=null;let pageLoadingState=null;let pageErrorState=null;let pageFiltersToggle=null;let pageFiltersPanel=null;let pageFilterSection=null;let pageFilterType=null;let pageDebounceTimer=null;let pageCurrentQuery='';let pageCurrentFilters={};let pageSelectedIndex=-1;let pageResultItems=[];function initSearchPage(){const isNewLayout=document.querySelector('.search-page__container');if(isNewLayout){initSearchPageNew();}else{initSearchPageLegacy();}}
let pageLoadingIndicator=null;function initSearchPageNew(){pageInput=document.getElementById('search-input');pageClearBtn=document.getElementById('search-clear');pageResults=document.getElementById('search-results');pageResultsList=document.getElementById('search-results-list');pageResultsCount=document.getElementById('search-results-count');pageNoResults=document.getElementById('search-no-results');pageNoResultsQuery=document.getElementById('search-no-results-query');pageEmptyState=document.getElementById('search-empty');pageLoadingState=document.getElementById('search-loading');pageLoadingIndicator=document.getElementById('search-loading-indicator');pageErrorState=document.getElementById('search-error');pageFiltersToggle=document.getElementById('filters-toggle');pageFiltersPanel=document.getElementById('search-filters');pageFilterSection=document.getElementById('filter-section');pageFilterType=document.getElementById('filter-type');if(!pageInput)return;const params=new URLSearchParams(window.location.search);const urlQuery=params.has('q')?params.get('q'):null;if(urlQuery&&!isIndexLoaded&&!isIndexLoading){log('URL has query, loading index immediately');loadSearchIndex();}
if(!isIndexLoaded){if(pageLoadingState)pageLoadingState.style.display='flex';if(pageEmptyState)pageEmptyState.style.display='none';window.addEventListener('searchIndexLoaded',onPageIndexLoaded);window.addEventListener('searchIndexError',onPageIndexError);}else{onPageIndexLoaded();}
pageInput.addEventListener('input',onPageInput);pageInput.addEventListener('keydown',onPageKeydown);if(pageClearBtn)pageClearBtn.addEventListener('click',clearPageSearch);if(pageFiltersToggle)pageFiltersToggle.addEventListener('click',togglePageFilters);if(pageFilterSection)pageFilterSection.addEventListener('change',onPageFilterChange);if(pageFilterType)pageFilterType.addEventListener('change',onPageFilterChange);const clearFiltersBtn=document.getElementById('clear-filters');if(clearFiltersBtn)clearFiltersBtn.addEventListener('click',clearPageFilters);document.querySelectorAll('.search-page__suggestion').forEach(btn=>{btn.addEventListener('click',()=>{pageInput.value=btn.dataset.query;pageInput.dispatchEvent(new Event('input'));pageInput.focus();});});if(urlQuery){pageInput.value=urlQuery;pageCurrentQuery=urlQuery;if(isIndexLoaded){performPageSearch(urlQuery);}
}
log('Search page initialized (new layout)');}
function onPageIndexLoaded(){if(pageLoadingState)pageLoadingState.style.display='none';if(pageLoadingIndicator)pageLoadingIndicator.style.display='none';populatePageFilters();if(pageCurrentQuery&&pageCurrentQuery.length>=CONFIG.minQueryLength){log('Index loaded, re-triggering search for: '+pageCurrentQuery);performPageSearch(pageCurrentQuery);}else if(pageEmptyState){pageEmptyState.style.display='flex';}}
function onPageIndexError(e){if(pageLoadingState)pageLoadingState.style.display='none';if(pageErrorState)pageErrorState.style.display='block';}
function populatePageFilters(){if(pageFilterSection){const sections=getAvailableSections();sections.forEach(section=>{const opt=document.createElement('option');opt.value=section;opt.textContent=section;pageFilterSection.appendChild(opt);});}
if(pageFilterType){const types=getAvailableTypes();types.forEach(type=>{const opt=document.createElement('option');opt.value=type;opt.textContent=type;pageFilterType.appendChild(opt);});}}
function onPageInput(e){const query=e.target.value.trim();if(pageClearBtn)pageClearBtn.style.display=query?'flex':'none';clearTimeout(pageDebounceTimer);pageDebounceTimer=setTimeout(()=>performPageSearch(query),CONFIG.modalDebounceDelay);}
function onPageKeydown(e){switch(e.key){case'ArrowDown':e.preventDefault();navigatePageResults(1);break;case'ArrowUp':e.preventDefault();navigatePageResults(-1);break;case'Enter':e.preventDefault();selectPageResult();break;case'Escape':if(pageCurrentQuery){e.preventDefault();clearPageSearch();}
break;}}
function performPageSearch(query){pageCurrentQuery=query;pageSelectedIndex=-1;pageResultItems=[];if(!query||query.length<CONFIG.minQueryLength){hidePageResults();if(pageEmptyState)pageEmptyState.style.display='flex';updatePageURL('');return;}
if(!isIndexLoaded){log('Search index not loaded yet, showing loading state');if(pageEmptyState)pageEmptyState.style.display='none';if(pageLoadingIndicator)pageLoadingIndicator.style.display='flex';hidePageResults();return;}
if(pageLoadingIndicator)pageLoadingIndicator.style.display='none';pageCurrentFilters={section:pageFilterSection?.value||null,type:pageFilterType?.value||null,tags:[]};const results=search(query,pageCurrentFilters);displayPageResults(results,query);updatePageURL(query);}
function displayPageResults(results,query){if(pageEmptyState)pageEmptyState.style.display='none';if(pageResultsList)pageResultsList.innerHTML='';if(results.length===0){if(pageResults)pageResults.style.display='block';if(pageNoResults)pageNoResults.style.display='flex';if(pageNoResultsQuery)pageNoResultsQuery.textContent=query;return;}
if(pageResults)pageResults.style.display='block';if(pageNoResults)pageNoResults.style.display='none';if(pageResultsCount){pageResultsCount.textContent=`${results.length}result${results.length!==1?'s':''}`;}
const{docs,api}=groupByAutodoc(results);let globalIndex=0;if(docs.length>0){const section=createPageResultSection('Documentation',docs,query,false,globalIndex);pageResultsList.appendChild(section);globalIndex+=docs.length;}
if(api.length>0){const section=createPageResultSection(`API Reference(${api.length})`,api,query,true,globalIndex);pageResultsList.appendChild(section);}
pageResultItems=Array.from(pageResultsList.querySelectorAll('.search-page__result-item'));}
function createPageResultSection(title,items,query,collapsed,startIndex){const section=document.createElement('div');section.className='search-page__results-group';const header=document.createElement('div');header.className='search-page__section-header'+(collapsed?' search-page__section-header--collapsible':'');header.innerHTML=`<span class="search-page__section-title">${title}</span>${collapsed?'<span class="search-page__section-toggle" aria-hidden="true">▶</span>':''}`;const itemsContainer=document.createElement('div');itemsContainer.className='search-page__section-items';if(collapsed){itemsContainer.style.display='none';itemsContainer.setAttribute('aria-hidden','true');}
items.forEach((result,localIndex)=>{const item=createPageResultItem(result,startIndex+localIndex);itemsContainer.appendChild(item);});if(collapsed){header.style.cursor='pointer';header.setAttribute('role','button');header.setAttribute('aria-expanded','false');header.setAttribute('tabindex','0');const toggle=()=>{const isHidden=itemsContainer.style.display==='none';itemsContainer.style.display=isHidden?'block':'none';itemsContainer.setAttribute('aria-hidden',!isHidden);header.querySelector('.search-page__section-toggle').textContent=isHidden?'▼':'▶';header.setAttribute('aria-expanded',isHidden);pageResultItems=Array.from(pageResultsList.querySelectorAll('.search-page__result-item'));};header.addEventListener('click',toggle);header.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();toggle();}});}
section.appendChild(header);section.appendChild(itemsContainer);return section;}
function createPageResultItem(result,index){const item=document.createElement('div');item.className='search-page__result-item';item.setAttribute('role','option');item.setAttribute('aria-selected','false');item.setAttribute('data-index',index);const href=result.href||result.uri;const title=result.highlightedTitle||result.title||'Untitled';const description=result.description||result.highlightedExcerpt||result.excerpt||'';const section=result.section||'';item.innerHTML=`<a href="${href}"class="search-page__result-link"tabindex="-1"><div class="search-page__result-content"><span class="search-page__result-title">${title}</span>${section?`<span class="search-page__result-section">${section}</span>`:''}
${result.isAutodoc?'<span class="search-page__autodoc-badge">API</span>':''}</div>${description?`<p class="search-page__result-excerpt">${description}</p>`:''}</a>`;item.addEventListener('click',(e)=>{e.preventDefault();pageSelectedIndex=index;selectPageResult();});return item;}
function navigatePageResults(direction){if(pageResultItems.length===0)return;if(pageSelectedIndex>=0&&pageSelectedIndex<pageResultItems.length){pageResultItems[pageSelectedIndex].classList.remove('search-page__result-item--selected');pageResultItems[pageSelectedIndex].setAttribute('aria-selected','false');}
pageSelectedIndex+=direction;if(pageSelectedIndex<0)pageSelectedIndex=pageResultItems.length-1;if(pageSelectedIndex>=pageResultItems.length)pageSelectedIndex=0;const selected=pageResultItems[pageSelectedIndex];selected.classList.add('search-page__result-item--selected');selected.setAttribute('aria-selected','true');selected.scrollIntoView({block:'nearest',behavior:'smooth'});}
function selectPageResult(){if(pageSelectedIndex>=0&&pageSelectedIndex<pageResultItems.length){const link=pageResultItems[pageSelectedIndex].querySelector('a');if(link)window.location.href=link.href;}}
function hidePageResults(){if(pageResults)pageResults.style.display='none';if(pageNoResults)pageNoResults.style.display='none';if(pageResultsList)pageResultsList.innerHTML='';pageSelectedIndex=-1;pageResultItems=[];}
function clearPageSearch(){if(pageInput)pageInput.value='';pageCurrentQuery='';if(pageClearBtn)pageClearBtn.style.display='none';if(pageLoadingIndicator)pageLoadingIndicator.style.display='none';hidePageResults();if(pageEmptyState)pageEmptyState.style.display='flex';updatePageURL('');if(pageInput)pageInput.focus();}
function togglePageFilters(){if(!pageFiltersToggle||!pageFiltersPanel)return;const isExpanded=pageFiltersToggle.getAttribute('aria-expanded')==='true';pageFiltersToggle.setAttribute('aria-expanded',!isExpanded);pageFiltersPanel.style.display=isExpanded?'none':'block';}
function onPageFilterChange(){if(pageCurrentQuery)performPageSearch(pageCurrentQuery);}
function clearPageFilters(){if(pageFilterSection)pageFilterSection.value='';if(pageFilterType)pageFilterType.value='';if(pageCurrentQuery)performPageSearch(pageCurrentQuery);}
function updatePageURL(query){const url=new URL(window.location);if(query){url.searchParams.set('q',query);}else{url.searchParams.delete('q');}
history.replaceState({},'',url);}
function initSearchPageLegacy(){document.querySelectorAll('.popular-search-link').forEach(link=>{link.addEventListener('click',function(e){e.preventDefault();const query=this.getAttribute('data-query');const searchInput=document.getElementById('search-input');if(!searchInput)return;searchInput.value=query;searchInput.dispatchEvent(new Event('input',{bubbles:true}));searchInput.focus();setTimeout(()=>{const results=document.getElementById('search-results');if(results)results.scrollIntoView({behavior:'smooth',block:'start'});},100);});});let query='';const params=new URLSearchParams(window.location.search);if(params.has('q')){query=params.get('q');}
else if(window.location.hash){query=decodeURIComponent(window.location.hash.substring(1));}
if(query){const searchInput=document.getElementById('search-input');if(searchInput){setTimeout(()=>{searchInput.value=query;searchInput.dispatchEvent(new Event('input',{bubbles:true}));searchInput.focus();},500);}}
log('Search page initialized (legacy layout)');}
function preloadSearch(){if(preloadTriggered||!window.BengalSearch)return;preloadTriggered=true;if(window.BengalUtils&&window.BengalUtils.log){window.BengalUtils.log('Preloading search index...');}
loadSearchIndex();}
function setupSmartPreload(){const searchTriggers=document.querySelectorAll('a[href$="/search/"], a[href*="search"], .nav-search-trigger, #nav-search-trigger');searchTriggers.forEach(function(el){el.addEventListener('mouseenter',preloadSearch,{once:true});el.addEventListener('focus',preloadSearch,{once:true});});document.addEventListener('keydown',function(e){if(e.metaKey||e.ctrlKey){preloadSearch();}},{once:true});}
function initPreload(){const metaEl=document.querySelector('meta[name="bengal:search_preload"]');const preloadMode=(metaEl&&metaEl.getAttribute('content'))||'smart';if(preloadMode==='immediate'){preloadSearch();}else if(preloadMode==='smart'){setupSmartPreload();}
}
window.BengalSearch={load:loadSearchIndex,search:search,groupResults:groupResults,getAvailableSections:getAvailableSections,getAvailableTypes:getAvailableTypes,getAvailableTags:getAvailableTags,getAvailableAuthors:getAvailableAuthors,isLoaded:()=>isIndexLoaded,isLoading:()=>isIndexLoading,getData:()=>searchData,highlightMatches:highlightMatches,formatDate:formatDate,openModal:openModal,closeModal:closeModal,isModalOpen:()=>isModalOpen,};window.BengalSearchModal={open:openModal,close:closeModal,isOpen:()=>isModalOpen,};window.BengalSearchPreload={trigger:preloadSearch};if(window.Bengal&&window.Bengal.enhance){Bengal.enhance.register('search',function(el,options){initSearchPage();});}
ready(()=>{if(document.getElementById('search-modal')){initModal();}
if(document.getElementById('search-input')){initSearchPage();}
initPreload();setTimeout(loadSearchIndex,500);});log('Bengal Search initialized (consolidated)');})();