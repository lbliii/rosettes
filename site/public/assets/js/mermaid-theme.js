(function(){'use strict';if(!window.BengalUtils){console.error('BengalUtils not loaded - mermaid-theme.js requires utils.js');return;}
const{log,ready}=window.BengalUtils;function getCSSVariable(variable,fallback='#000000',cachedStyles=null){const styles=cachedStyles||getComputedStyle(document.documentElement);const value=styles.getPropertyValue(variable).trim();return value||fallback;}
function isDarkMode(){const htmlEl=document.documentElement;const themeAttr=htmlEl.getAttribute('data-theme');if(themeAttr==='dark')return true;if(htmlEl.classList.contains('dark'))return true;if(window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches){return true;}
return false;}
function getMermaidThemeConfig(){const darkMode=isDarkMode();const cachedStyles=getComputedStyle(document.documentElement);const primaryColorRaw=getCSSVariable('--color-primary','#4FA8A0',cachedStyles);const primaryHover=getCSSVariable('--color-primary-hover','#3D9287',cachedStyles);const primaryDark=getCSSVariable('--color-primary-dark','#236962',cachedStyles);const primaryTextColor=getCSSVariable('--color-text-inverse','#FFFFFF',cachedStyles);const textColor=getCSSVariable('--color-text-primary','#252525',cachedStyles);const secondaryTextColor=getCSSVariable('--color-text-secondary','#5F5B56',cachedStyles);const bgPrimary=getCSSVariable('--color-bg-primary','#FDFCF9',cachedStyles);const bgSecondary=getCSSVariable('--color-bg-secondary','#F9F6F0',cachedStyles);const bgTertiary=getCSSVariable('--color-bg-tertiary','#F2EDE3',cachedStyles);const borderColor=getCSSVariable('--color-border','#E5DFD6',cachedStyles);const borderStrong=getCSSVariable('--color-border-strong','#CFC7BC',cachedStyles);const accentColorRaw=getCSSVariable('--color-accent','#5BB8AF',cachedStyles);const accentHover=getCSSVariable('--color-accent-hover','#4FA8A0',cachedStyles);const successColorRaw=getCSSVariable('--color-success','#2E7D5A',cachedStyles);const successDark=getCSSVariable('--color-success-text','#1B5E42',cachedStyles);const warningColorRaw=getCSSVariable('--color-warning','#D97706',cachedStyles);const warningDark=getCSSVariable('--color-warning-text','#7C3E03',cachedStyles);const errorColorRaw=getCSSVariable('--color-error','#C62828',cachedStyles);const errorDark=getCSSVariable('--color-error-text','#7F1D1D',cachedStyles);const infoColorRaw=getCSSVariable('--color-info','#3D9DAF',cachedStyles);const infoDark=getCSSVariable('--color-info-text','#1E5C6B',cachedStyles);const primaryColor=darkMode?primaryColorRaw:(primaryHover||primaryDark||primaryColorRaw);const accentColor=darkMode?accentColorRaw:(accentHover||accentColorRaw);const successColor=darkMode?successColorRaw:(successDark||successColorRaw);const warningColor=darkMode?warningColorRaw:(warningDark||warningColorRaw);const errorColor=darkMode?errorColorRaw:(errorDark||errorColorRaw);const infoColor=darkMode?infoColorRaw:(infoDark||infoColorRaw);const successTextColor=getCSSVariable('--color-success-text','#000000',cachedStyles);const warningTextColor=getCSSVariable('--color-warning-text','#000000',cachedStyles);const errorTextColor=getCSSVariable('--color-error-text','#000000',cachedStyles);const infoTextColor=getCSSVariable('--color-info-text','#000000',cachedStyles);const textOnPrimary=primaryTextColor;const textOnSuccess=successTextColor||textColor;const textOnWarning=warningTextColor||textColor;const textOnError=errorTextColor||textColor;return{theme:'base',themeVariables:{darkMode:darkMode,primaryColor:primaryColor,primaryTextColor:textColor,primaryBorderColor:borderStrong,secondaryColor:accentColor,secondaryTextColor:textColor,secondaryBorderColor:borderColor,tertiaryColor:accentColor,tertiaryTextColor:secondaryTextColor,tertiaryBorderColor:borderColor,background:bgPrimary,mainBkg:darkMode?bgSecondary:bgTertiary,secondBkg:darkMode?bgTertiary:borderColor,tertiaryBkg:darkMode?bgTertiary:borderColor,textColor:textColor,lineColor:borderStrong,secondaryBorderColor:borderColor,tertiaryBorderColor:borderColor,border1:borderColor,border2:borderStrong,edgeLabelBackground:bgPrimary,clusterBkg:bgSecondary,clusterBorder:borderColor,noteBkgColor:bgSecondary,noteTextColor:textColor,noteBorderColor:borderColor,actorBkg:bgSecondary,actorBorder:borderStrong,actorTextColor:textColor,actorLineColor:borderStrong,activationBkgColor:primaryColor,activationBorderColor:primaryHover,activationTextColor:textOnPrimary,sequenceNumberColor:textOnPrimary,sectionBkgColor:bgTertiary,sectionBkgColor2:bgSecondary,altSectionBkgColor:bgSecondary,excludeBkgColor:bgTertiary,taskBkgColor:primaryColor,taskTextColor:textOnPrimary,taskTextLightColor:secondaryTextColor,taskTextOutsideColor:textColor,taskTextClickableColor:primaryColor,activeTaskBkgColor:primaryHover,activeTaskBorderColor:borderStrong,gridColor:borderColor,doneTaskBkgColor:successColor,doneTaskBorderColor:borderStrong,doneTaskTextColor:textOnSuccess,critBorderColor:errorColor,critBkgColor:errorColor,critTaskTextColor:textOnError,todayLineColor:warningColor,labelColor:textColor,errorBkgColor:errorColor,errorTextColor:textOnError,c4LabelColor:textColor,c4LabelBackground:bgPrimary,c4LabelBorder:borderColor,pie1:primaryColor,pie2:accentColor,pie3:successColor,pie4:infoColor,pie5:warningColor,pie6:errorColor,pie7:primaryHover,pieTitleTextSize:'25px',pieTitleTextColor:textColor,pieSectionTextSize:'17px',pieSectionTextColor:textOnPrimary,pieLegendTextSize:'17px',pieLegendTextColor:textColor,pieStrokeColor:borderStrong,pieStrokeWidth:'2px',requirementBackground:bgSecondary,requirementBorderColor:borderStrong,requirementTextColor:textColor,relationColor:borderStrong,relationLabelBackground:bgPrimary,relationLabelColor:textColor,commitLabelColor:textOnPrimary,commitLabelBackground:primaryColor,commitLabelFontSize:'10px',branchLabelColor:textColor,branchLabelFontSize:'11px',tagLabelColor:textOnPrimary,tagLabelBackground:accentColor,tagLabelFontSize:'10px',tagLabelBorder:borderStrong,commit0:primaryColor,commit1:accentColor,commit2:successColor,commit3:infoColor,commit4:warningColor,commit5:errorColor,commit6:primaryHover,commit7:accentColor,entityBkg:bgSecondary,entityBorder:borderStrong,attributeBkgOdd:bgPrimary,attributeBkgEven:bgSecondary,attributeTextColor:textColor,cScale0:primaryColor,cScale1:accentColor,cScale2:successColor,fillType0:primaryColor,fillType1:accentColor,fillType2:successColor,fillType3:infoColor,quadrant1Fill:primaryColor,quadrant2Fill:accentColor,quadrant3Fill:successColor,quadrant4Fill:infoColor,quadrantPointFill:textColor,quadrantPointTextColor:textOnPrimary,quadrantXAxisTextColor:textColor,quadrantYAxisTextColor:textColor}};}
function preserveMermaidSyntax(){const mermaidElements=document.querySelectorAll('.mermaid');mermaidElements.forEach(function(element){if(!element.hasAttribute('data-mermaid-syntax')){const textContent=element.textContent.trim();if(textContent){const decoded=decodeHtmlEntities(textContent);element.setAttribute('data-mermaid-syntax',decoded.trim());}}});}
function registerIconPacks(){if(typeof mermaid!=='undefined'&&mermaid.registerIconPacks){mermaid.registerIconPacks([{name:'fa',loader:()=>fetch('https://unpkg.com/@iconify-json/fa@1/icons.json').then((res)=>res.json()).catch(()=>null)},{name:'mdi',loader:()=>fetch('https://unpkg.com/@iconify-json/mdi@1/icons.json').then((res)=>res.json()).catch(()=>null)},{name:'logos',loader:()=>fetch('https://unpkg.com/@iconify-json/logos@1/icons.json').then((res)=>res.json()).catch(()=>null)}]);}}
function initializeMermaid(){const mermaidElements=document.querySelectorAll('.mermaid');if(mermaidElements.length===0||typeof mermaid==='undefined'){return;}
registerIconPacks();preserveMermaidSyntax();if(window.BengalMermaidToolbar&&window.BengalMermaidToolbar.preserveSyntax){window.BengalMermaidToolbar.preserveSyntax();}
const mermaidConfig=getMermaidThemeConfig();mermaid.initialize({startOnLoad:false,theme:mermaidConfig.theme,themeVariables:mermaidConfig.themeVariables,securityLevel:'loose',flowchart:{useMaxWidth:true,htmlLabels:true}});mermaid.run().then(()=>{if(window.BengalMermaidToolbar){window.BengalMermaidToolbar.setupToolbars();}});}
function decodeHtmlEntities(text){const textarea=document.createElement('textarea');textarea.innerHTML=text;return textarea.value;}
function restoreMermaidSyntax(){const mermaidElements=document.querySelectorAll('.mermaid');mermaidElements.forEach(function(element){let storedSyntax=element.getAttribute('data-mermaid-syntax');if(!storedSyntax){const textContent=element.textContent.trim();if(textContent&&!element.querySelector('svg')){storedSyntax=decodeHtmlEntities(textContent);element.setAttribute('data-mermaid-syntax',storedSyntax);}}
if(storedSyntax){element.innerHTML='';Array.from(element.attributes).forEach(function(attr){if(attr.name.startsWith('data-')&&attr.name!=='data-mermaid-syntax'){element.removeAttribute(attr.name);}});element.textContent=storedSyntax;if(!element.classList.contains('mermaid')){element.classList.add('mermaid');}}});}
function setupThemeObserver(){let reRenderTimeout=null;function handleThemeChange(){const mermaidElements=document.querySelectorAll('.mermaid');if(mermaidElements.length===0||typeof mermaid==='undefined'){return;}
if(reRenderTimeout){clearTimeout(reRenderTimeout);}
reRenderTimeout=setTimeout(function(){restoreMermaidSyntax();const updatedConfig=getMermaidThemeConfig();mermaid.initialize({startOnLoad:false,theme:updatedConfig.theme,themeVariables:updatedConfig.themeVariables,securityLevel:'loose',flowchart:{useMaxWidth:true,htmlLabels:true}});const elementsToRender=document.querySelectorAll('.mermaid');if(elementsToRender.length>0){mermaid.run({nodes:Array.from(elementsToRender),suppressErrors:false}).then(()=>{if(window.BengalMermaidToolbar){window.BengalMermaidToolbar.setupToolbars();}}).catch(function(error){log('Mermaid re-render error:',error);mermaid.run({querySelector:'.mermaid',suppressErrors:true}).then(()=>{if(window.BengalMermaidToolbar){window.BengalMermaidToolbar.setupToolbars();}});});}},50);}
window.addEventListener('themechange',handleThemeChange);window.addEventListener('palettechange',handleThemeChange);}
function init(){ready(function(){initializeMermaid();setupThemeObserver();log('Mermaid theme initialized');});}
init();window.BengalMermaidTheme={getMermaidThemeConfig:getMermaidThemeConfig,initializeMermaid:initializeMermaid,setupThemeObserver:setupThemeObserver};})();