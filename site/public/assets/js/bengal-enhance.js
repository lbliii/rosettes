(function(){'use strict';const REGISTRY={};const ENHANCED=new WeakSet();const PENDING_LOADS=new Map();const CONFIG={debug:(window.Bengal&&window.Bengal.debug)||false,watchDom:(window.Bengal&&window.Bengal.watchDom!==false)||true,baseUrl:(window.Bengal&&window.Bengal.enhanceBaseUrl)||'/assets/js/enhancements',urls:(window.Bengal&&window.Bengal.enhanceUrls)||{}};function log(...args){if(CONFIG.debug){console.log('[Bengal]',...args);}}
function register(name,init,options={}){if(REGISTRY[name]&&!options.override){log(`Enhancement"${name}"already registered`);return false;}
REGISTRY[name]={init,options};log(`Registered enhancement:${name}`);if(PENDING_LOADS.has(name)){const pendingElements=PENDING_LOADS.get(name);PENDING_LOADS.delete(name);pendingElements.forEach(el=>applyEnhancement(el,REGISTRY[name]));}
return true;}
function parseValue(value){if(value==='true')return true;if(value==='false')return false;if(value==='')return true;if(!isNaN(value)&&value!=='')return Number(value);try{return JSON.parse(value);}catch{return value;}}
function extractOptions(el){const options={};for(const[key,value]of Object.entries(el.dataset)){if(key!=='bengal'&&key!=='enhanced'&&key!=='enhanceError'){options[key]=parseValue(value);}}
return options;}
function applyEnhancement(el,enhancement){if(ENHANCED.has(el))return;try{const options=extractOptions(el);enhancement.init(el,options);ENHANCED.add(el);el.setAttribute('data-enhanced','true');log(`Enhanced:${el.dataset.bengal}`,el);}catch(err){console.error(`[Bengal]Enhancement error(${el.dataset.bengal}):`,err);el.setAttribute('data-enhance-error','true');}}
async function loadEnhancement(name){if(PENDING_LOADS.has(name)){return;}
const url=CONFIG.urls[name]||`${CONFIG.baseUrl}/${name}.js`;PENDING_LOADS.set(name,[]);try{await import(url);log(`Loaded enhancement via import:${name}`);}catch(err){return new Promise((resolve)=>{const script=document.createElement('script');script.src=url;script.onload=()=>{log(`Loaded enhancement via script tag:${name}`);resolve();};script.onerror=()=>{log(`Failed to load enhancement:${name}`);PENDING_LOADS.delete(name);resolve();};document.head.appendChild(script);});}}
function enhanceElement(el){if(ENHANCED.has(el))return;const name=el.dataset.bengal;if(!name)return;const enhancement=REGISTRY[name];if(enhancement){applyEnhancement(el,enhancement);}else{if(!PENDING_LOADS.has(name)){loadEnhancement(name);PENDING_LOADS.set(name,[el]);}else{PENDING_LOADS.get(name).push(el);}}}
function enhanceAll(root=document){const elements=root.querySelectorAll('[data-bengal]:not([data-enhanced])');elements.forEach(enhanceElement);}
function setupDomWatcher(){if(!CONFIG.watchDom)return;let pendingNodes=[];let debounceTimer=null;function processPendingNodes(){if(pendingNodes.length===0)return;const nodesToProcess=pendingNodes;pendingNodes=[];nodesToProcess.forEach((node)=>{if(node.dataset&&node.dataset.bengal){enhanceElement(node);}
enhanceAll(node);});}
const observer=new MutationObserver((mutations)=>{mutations.forEach((mutation)=>{mutation.addedNodes.forEach((node)=>{if(node.nodeType===Node.ELEMENT_NODE){pendingNodes.push(node);}});});if(debounceTimer)clearTimeout(debounceTimer);debounceTimer=setTimeout(processPendingNodes,50);});observer.observe(document.body,{childList:true,subtree:true});log('DOM watcher initialized (debounced)');window.BENGAL_DOM_OBSERVER=observer;}
function init(){enhanceAll();setupDomWatcher();log('Enhancement system initialized');}
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',()=>setTimeout(init,0));}else{setTimeout(init,0);}
window.Bengal=window.Bengal||{};window.Bengal.enhance={register,enhanceAll,enhanceElement,list:()=>Object.keys(REGISTRY),get:(name)=>REGISTRY[name],isEnhanced:(el)=>ENHANCED.has(el),configure:(options)=>{Object.assign(CONFIG,options);}};log('Bengal enhance API ready');})();