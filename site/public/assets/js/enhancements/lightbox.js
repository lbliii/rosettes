(function(){'use strict';if(!window.BengalUtils){console.error('BengalUtils not loaded - lightbox.js requires utils.js');return;}
const{log,ready}=window.BengalUtils;let dialog=null;let currentImage=null;function getDialog(){if(dialog)return dialog;dialog=document.getElementById('lightbox-dialog');if(!dialog){dialog=document.createElement('dialog');dialog.id='lightbox-dialog';dialog.className='lightbox-dialog';dialog.setAttribute('aria-label','Image lightbox');const img=document.createElement('img');img.className='lightbox-dialog__image';img.alt='';const form=document.createElement('form');form.method='dialog';form.className='lightbox-dialog__controls';const closeButton=document.createElement('button');closeButton.type='submit';closeButton.className='lightbox-dialog__close';closeButton.setAttribute('aria-label','Close lightbox');closeButton.innerHTML=`<svg viewBox="0 0 24 24"fill="none"stroke="currentColor"stroke-width="2.5"stroke-linecap="round"stroke-linejoin="round"><line x1="18"y1="6"x2="6"y2="18"></line><line x1="6"y1="6"x2="18"y2="18"></line></svg>`;form.appendChild(closeButton);const caption=document.createElement('div');caption.className='lightbox-dialog__caption';dialog.appendChild(img);dialog.appendChild(form);dialog.appendChild(caption);document.body.appendChild(dialog);}
dialog.addEventListener('click',function(e){if(e.target===dialog){dialog.close();}});dialog.addEventListener('keydown',handleKeyboard);return dialog;}
function openLightbox(imgElement){const d=getDialog();currentImage=imgElement;const img=d.querySelector('.lightbox-dialog__image');const caption=d.querySelector('.lightbox-dialog__caption');const highResSrc=imgElement.getAttribute('data-lightbox-src')||imgElement.src;img.src=highResSrc;img.alt=imgElement.alt;const captionText=imgElement.alt||imgElement.getAttribute('data-caption');if(captionText){caption.textContent=captionText;caption.style.display='block';}else{caption.style.display='none';}
d.showModal();}
function closeLightbox(){if(!dialog)return;dialog.close();if(currentImage){currentImage.focus();}
currentImage=null;}
function handleKeyboard(e){if(!dialog||!dialog.open)return;switch(e.key){case'ArrowLeft':navigateImages(-1);e.preventDefault();break;case'ArrowRight':navigateImages(1);e.preventDefault();break;}}
function navigateImages(direction){if(!currentImage)return;const images=Array.from(document.querySelectorAll('[data-lightbox]'));const currentIndex=images.indexOf(currentImage);if(currentIndex===-1||images.length<=1)return;let newIndex=currentIndex+direction;if(newIndex<0)newIndex=images.length-1;if(newIndex>=images.length)newIndex=0;openLightbox(images[newIndex]);}
function setupImageLightbox(){const selectors=['.prose img','.docs-content img','article img','main img'];const images=document.querySelectorAll(selectors.join(', '));images.forEach(img=>{if(img.hasAttribute('data-lightbox')||img.hasAttribute('data-no-lightbox')){return;}
if(img.width<400&&img.height<400){return;}
if(img.closest('a')){return;}
img.setAttribute('data-lightbox','');img.setAttribute('tabindex','0');img.setAttribute('role','button');img.setAttribute('aria-label',`View larger version of:${img.alt||'image'}`);img.addEventListener('click',function(){openLightbox(this);});img.addEventListener('keypress',function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();openLightbox(this);}});});}
function init(){setupImageLightbox();log('Image lightbox initialized (native dialog)');}
ready(init);let mutationObserver=null;let updateTimeout=null;if(typeof MutationObserver!=='undefined'){let isUpdating=false;const{debounce}=window.BengalUtils||{};const debouncedSetup=debounce?debounce(function(){if(!isUpdating){isUpdating=true;setupImageLightbox();setTimeout(function(){isUpdating=false;},100);}},250):function(){if(isUpdating)return;clearTimeout(updateTimeout);updateTimeout=setTimeout(function(){if(!isUpdating){isUpdating=true;setupImageLightbox();setTimeout(function(){isUpdating=false;},100);}},250);};mutationObserver=new MutationObserver(function(mutations){if(isUpdating)return;let shouldUpdate=false;mutations.forEach(function(mutation){if(mutation.addedNodes.length>0){mutation.addedNodes.forEach(function(node){if(node.nodeType!==1)return;if(node.tagName==='SCRIPT'||node.tagName==='STYLE')return;if(node.id&&(node.id.includes('devtools')||node.id.includes('chrome-devtools')||node.id.includes('firefox-devtools')||node.id.includes('__react')||node.id.includes('__vue')))return;if(node.className&&typeof node.className==='string'&&(node.className.includes('devtools')||node.className.includes('chrome-devtools')))return;const isInContentArea=node.closest&&(node.closest('.prose')||node.closest('.docs-content')||node.closest('article')||node.closest('main'));if(isInContentArea&&(node.nodeName==='IMG'||(node.querySelector&&node.querySelector('img')))){shouldUpdate=true;}});}});if(shouldUpdate){debouncedSetup();}});const contentAreas=document.querySelectorAll('.prose, .docs-content, article, main');if(contentAreas.length>0){contentAreas.forEach(function(area){if(mutationObserver){mutationObserver.observe(area,{childList:true,subtree:true});}});}else{if(mutationObserver){mutationObserver.observe(document.body,{childList:true,subtree:true});}}}
function cleanup(){if(mutationObserver){mutationObserver.disconnect();mutationObserver=null;}
if(updateTimeout){clearTimeout(updateTimeout);updateTimeout=null;}}
if(window.Bengal&&window.Bengal.enhance){Bengal.enhance.register('lightbox',function(el,options){log('[BengalLightbox] Registered via enhancement system');});}
window.addEventListener('beforeunload',cleanup);window.BengalLightbox={cleanup:cleanup,open:openLightbox,close:closeLightbox};})();