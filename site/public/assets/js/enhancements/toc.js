(function(){'use strict';if(!window.BengalUtils){console.error('BengalUtils not loaded - toc.js requires utils.js');return;}
const{throttleScroll,debounce,ready}=window.BengalUtils;let currentActiveIndex=-1;let isCompactMode=false;let collapsedGroups=new Set();let tocItems=[];let progressBar=null;let progressPosition=null;let tocNav=null;let tocGroups=[];let tocScrollContainer=null;let headings=[];let scrollHandler=null;let hashChangeHandler=null;let resizeHandler=null;let keyboardHandler=null;function loadState(){try{const savedState=localStorage.getItem('toc-state');if(savedState){const state=JSON.parse(savedState);isCompactMode=state.compact||false;collapsedGroups=new Set();if(isCompactMode&&tocNav){tocNav.setAttribute('data-toc-mode','compact');}}}catch(e){}}
function saveState(){try{localStorage.setItem('toc-state',JSON.stringify({compact:isCompactMode,collapsed:Array.from(collapsedGroups)}));}catch(e){}}
function updateProgress(){const scrollTop=window.scrollY;const docHeight=document.documentElement.scrollHeight-window.innerHeight;const progress=Math.min((scrollTop/docHeight)*100,100);if(progressBar){progressBar.style.height=`${progress}%`;}
if(progressPosition){progressPosition.style.top=`${progress}%`;}}
function updateActiveItem(){const viewportOffset=120;const headingRects=headings.map(heading=>({top:heading.element.getBoundingClientRect().top,heading:heading}));let containerRect=null;if(tocScrollContainer){containerRect=tocScrollContainer.getBoundingClientRect();}
let activeIndex=0;for(let i=headingRects.length-1;i>=0;i--){if(headingRects[i].top<=viewportOffset){activeIndex=i;break;}}
if(activeIndex===currentActiveIndex)return;currentActiveIndex=activeIndex;const activeHeading=headings[activeIndex];const activeLink=activeHeading?activeHeading.link:null;const activeParentGroup=activeLink?activeLink.closest('details.toc-group'):null;headings.forEach((heading,index)=>{if(index===activeIndex){heading.link.classList.add('active');}else{heading.link.classList.remove('active');}});if(activeParentGroup){const groupId=getGroupId(activeParentGroup);if(!activeParentGroup.open){expandGroup(activeParentGroup,groupId);}
tocGroups.forEach(group=>{if(group!==activeParentGroup){const otherGroupId=getGroupId(group);if(group.open){collapseGroup(group,otherGroupId);}}});}else{tocGroups.forEach(group=>{const groupId=getGroupId(group);if(group.open){collapseGroup(group,groupId);}});}
if(tocScrollContainer&&activeLink&&containerRect){const linkRect=activeLink.getBoundingClientRect();if(linkRect.top<containerRect.top||linkRect.bottom>containerRect.bottom){activeLink.scrollIntoView({behavior:'smooth',block:'nearest'});}}}
function updateOnScroll(){updateProgress();updateActiveItem();}
function getGroupId(group){const link=group.querySelector('[data-toc-item]');return link?link.getAttribute('data-toc-item'):null;}
function collapseGroup(group,groupId){group.removeAttribute('open');if(groupId){collapsedGroups.add(groupId);}
saveState();}
function expandGroup(group,groupId){group.setAttribute('open','');if(groupId){collapsedGroups.delete(groupId);}
saveState();}
function initGroupToggles(){tocGroups.forEach(group=>{const groupId=getGroupId(group);group.addEventListener('toggle',()=>{if(group.open){if(groupId)collapsedGroups.delete(groupId);}else{if(groupId)collapsedGroups.add(groupId);}
saveState();});});}
function initControlButtons(){const toggleAllBtn=document.querySelector('[data-toc-action="toggle-all"]');if(toggleAllBtn){toggleAllBtn.addEventListener('click',(e)=>{e.stopPropagation();const anyExpanded=tocGroups.some(group=>group.open);if(anyExpanded){tocGroups.forEach(group=>{const groupId=getGroupId(group);collapseGroup(group,groupId);});toggleAllBtn.setAttribute('aria-expanded','false');toggleAllBtn.setAttribute('aria-label','Expand all sections');}else{tocGroups.forEach(group=>{const groupId=getGroupId(group);expandGroup(group,groupId);});toggleAllBtn.setAttribute('aria-expanded','true');toggleAllBtn.setAttribute('aria-label','Collapse all sections');}});}
const settingsBtn=document.querySelector('[data-toc-action="toggle-settings"]');const settingsMenu=document.querySelector('.toc-settings-menu');if(settingsBtn&&settingsMenu){settingsBtn.addEventListener('click',(e)=>{e.stopPropagation();const isHidden=settingsMenu.hasAttribute('hidden');if(isHidden){settingsMenu.removeAttribute('hidden');settingsBtn.setAttribute('aria-expanded','true');}else{settingsMenu.setAttribute('hidden','');settingsBtn.setAttribute('aria-expanded','false');}});document.addEventListener('click',(e)=>{if(!settingsMenu.contains(e.target)&&!settingsBtn.contains(e.target)){settingsMenu.setAttribute('hidden','');settingsBtn.setAttribute('aria-expanded','false');}});}
const expandAllBtn=document.querySelector('[data-toc-action="expand-all"]');if(expandAllBtn){expandAllBtn.addEventListener('click',()=>{tocGroups.forEach(group=>{const groupId=getGroupId(group);expandGroup(group,groupId);});if(settingsMenu)settingsMenu.setAttribute('hidden','');});}
const collapseAllBtn=document.querySelector('[data-toc-action="collapse-all"]');if(collapseAllBtn){collapseAllBtn.addEventListener('click',()=>{tocGroups.forEach(group=>{const groupId=getGroupId(group);collapseGroup(group,groupId);});if(settingsMenu)settingsMenu.setAttribute('hidden','');});}}
function initSmoothScroll(){tocItems.forEach(item=>{item.addEventListener('click',(e)=>{e.preventDefault();const id=item.getAttribute('data-toc-item').slice(1);const target=document.getElementById(id);if(target){const offsetTop=target.offsetTop-100;window.scrollTo({top:offsetTop,behavior:'smooth'});history.replaceState(null,'','#'+id);}});});}
let focusedIndex=-1;let allLinks=[];function handleKeydown(e){if(!document.querySelector('.toc-sidebar:focus-within'))return;if(e.key==='ArrowDown'){e.preventDefault();focusedIndex=Math.min(focusedIndex+1,allLinks.length-1);allLinks[focusedIndex]?.focus();}else if(e.key==='ArrowUp'){e.preventDefault();focusedIndex=Math.max(focusedIndex-1,0);allLinks[focusedIndex]?.focus();}else if(e.key==='Enter'&&focusedIndex>=0){allLinks[focusedIndex]?.click();}else if(e.key==='Home'){e.preventDefault();focusedIndex=0;allLinks[0]?.focus();}else if(e.key==='End'){e.preventDefault();focusedIndex=allLinks.length-1;allLinks[focusedIndex]?.focus();}}
function initKeyboardNavigation(){allLinks=Array.from(tocItems);allLinks.forEach((link,index)=>{link.addEventListener('focus',()=>{focusedIndex=index;});});keyboardHandler=handleKeydown;document.addEventListener('keydown',keyboardHandler);}
scrollHandler=throttleScroll(updateOnScroll);function initTOC(){tocItems=Array.from(document.querySelectorAll('[data-toc-item]'));progressBar=document.querySelector('.toc-progress-bar');progressPosition=document.querySelector('.toc-progress-position');tocNav=document.querySelector('.toc-nav');tocGroups=Array.from(document.querySelectorAll('details.toc-group'));tocScrollContainer=document.querySelector('.toc-scroll-container');if(!tocItems.length)return;headings=tocItems.map(item=>{const id=item.getAttribute('data-toc-item').slice(1);const element=document.getElementById(id);return element?{id,element,link:item}:null;}).filter(Boolean);if(!headings.length)return;loadState();initGroupToggles();initControlButtons();initSmoothScroll();initKeyboardNavigation();window.addEventListener('scroll',scrollHandler,{passive:true});updateOnScroll();hashChangeHandler=updateActiveItem;window.addEventListener('hashchange',hashChangeHandler);resizeHandler=debounce(updateActiveItem,250);window.addEventListener('resize',resizeHandler,{passive:true});}
function cleanup(){if(scrollHandler){window.removeEventListener('scroll',scrollHandler);scrollHandler=null;}
if(hashChangeHandler){window.removeEventListener('hashchange',hashChangeHandler);hashChangeHandler=null;}
if(resizeHandler){window.removeEventListener('resize',resizeHandler);resizeHandler=null;}
if(keyboardHandler){document.removeEventListener('keydown',keyboardHandler);keyboardHandler=null;}}
if(window.Bengal&&window.Bengal.enhance){Bengal.enhance.register('toc',function(el,options){initTOC();});}
ready(initTOC);window.addEventListener('contentLoaded',initTOC);window.BengalTOC={init:initTOC,cleanup:cleanup,updateActiveItem:updateActiveItem,expandAll:()=>{tocGroups.forEach(group=>{const groupId=getGroupId(group);expandGroup(group,groupId);});},collapseAll:()=>{tocGroups.forEach(group=>{const groupId=getGroupId(group);collapseGroup(group,groupId);});}};})();