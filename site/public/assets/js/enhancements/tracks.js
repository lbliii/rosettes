(function(){'use strict';if(!window.BengalUtils){console.error('BengalUtils not loaded - tracks.js requires utils.js');return;}
const{throttleScroll,ready}=window.BengalUtils;const STORAGE_KEY_PREFIX='bengal_track_progress_';const SELECTORS={trackNav:'[data-bengal="track-nav"]',trackSection:'[data-track-section]',sectionTarget:'.track-section',tocSidebar:'.track-layout .toc-sidebar',tocGroup:'.toc-group'};let trackNav=null;let trackId=null;let trackSections=[];let sidebarLinks=[];let tocGroups=[];let tocSidebar=null;let currentSectionIndex=-1;let scrollHandler=null;let progress={visited:[],lastSection:0};function getStorageKey(){return STORAGE_KEY_PREFIX+(trackId||'default');}
function loadProgress(){try{const stored=localStorage.getItem(getStorageKey());if(stored){const parsed=JSON.parse(stored);progress={visited:Array.isArray(parsed.visited)?parsed.visited:[],lastSection:typeof parsed.lastSection==='number'?parsed.lastSection:0};}}catch(e){progress={visited:[],lastSection:0};}}
function saveProgress(){try{localStorage.setItem(getStorageKey(),JSON.stringify(progress));}catch(e){}}
function markSectionVisited(sectionIndex){if(!progress.visited.includes(sectionIndex)){progress.visited.push(sectionIndex);saveProgress();}
const link=sidebarLinks[sectionIndex];if(link&&!link.hasAttribute('data-track-visited')){link.setAttribute('data-track-visited','');}}
function updateCompletedSections(){const viewportOffset=150;trackSections.forEach((section,index)=>{const rect=section.getBoundingClientRect();const link=sidebarLinks[index];if(rect.bottom<viewportOffset&&link){if(!link.hasAttribute('data-track-completed')){link.setAttribute('data-track-completed','');markSectionVisited(index);}}});}
function restoreVisitedState(){progress.visited.forEach(index=>{const link=sidebarLinks[index];if(link){link.setAttribute('data-track-visited','');}});}
function getCurrentSectionIndex(){const viewportOffset=150;for(let i=trackSections.length-1;i>=0;i--){const section=trackSections[i];const rect=section.getBoundingClientRect();if(rect.top<=viewportOffset){return i;}}
return 0;}
function updateCurrentSection(){const newIndex=getCurrentSectionIndex();updateCompletedSections();if(newIndex===currentSectionIndex)return;const previousIndex=currentSectionIndex;currentSectionIndex=newIndex;progress.lastSection=currentSectionIndex;saveProgress();markSectionVisited(currentSectionIndex);sidebarLinks.forEach((link,index)=>{if(index===currentSectionIndex){link.setAttribute('data-track-active','');link.setAttribute('aria-current','step');link.classList.add('is-active');}else{link.removeAttribute('data-track-active');link.removeAttribute('aria-current');link.classList.remove('is-active');}});if(tocSidebar){tocSidebar.setAttribute('data-track-filtering','true');tocSidebar.setAttribute('data-track-active-section',currentSectionIndex+1);tocGroups.forEach((group,index)=>{if(index===currentSectionIndex){group.setAttribute('data-toc-active','');}else{group.removeAttribute('data-toc-active');}});}
announceToScreenReader(currentSectionIndex);}
let announceTimeout=null;function announceToScreenReader(sectionIndex){if(announceTimeout){clearTimeout(announceTimeout);}
announceTimeout=setTimeout(()=>{const link=sidebarLinks[sectionIndex];if(!link)return;const label=link.querySelector('.track-nav-label');const number=link.querySelector('.track-nav-number');const sectionName=label?label.textContent.trim():'';const sectionNum=number?number.textContent.trim():sectionIndex+1;let liveRegion=document.getElementById('track-live-region');if(!liveRegion){liveRegion=document.createElement('div');liveRegion.id='track-live-region';liveRegion.setAttribute('aria-live','polite');liveRegion.setAttribute('aria-atomic','true');liveRegion.className='visually-hidden';document.body.appendChild(liveRegion);}
liveRegion.textContent=`Section ${sectionNum}:${sectionName}`;},300);}
function checkResume(){if(progress.lastSection>0&&progress.visited.length>0){const currentScroll=window.scrollY;if(currentScroll<200){showResumePrompt();}}}
function showResumePrompt(){const targetSection=trackSections[progress.lastSection];if(!targetSection)return;const link=sidebarLinks[progress.lastSection];const label=link?link.querySelector('.track-nav-label'):null;const sectionName=label?label.textContent.trim():`Section ${progress.lastSection+1}`;const banner=document.createElement('div');banner.className='track-resume-banner';banner.setAttribute('role','status');banner.innerHTML=`<span class="track-resume-text">Continue where you left off?</span><button class="track-resume-button"type="button">Resume:${sectionName}</button><button class="track-resume-dismiss"type="button"aria-label="Dismiss"><svg width="16"height="16"viewBox="0 0 24 24"fill="none"stroke="currentColor"stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>`;const trackContent=document.querySelector('.track-content');if(trackContent){trackContent.insertBefore(banner,trackContent.firstChild);}
banner.querySelector('.track-resume-button').addEventListener('click',()=>{targetSection.scrollIntoView({behavior:'smooth'});banner.remove();});banner.querySelector('.track-resume-dismiss').addEventListener('click',()=>{banner.classList.add('track-resume-banner--dismissed');setTimeout(()=>banner.remove(),300);});const dismissOnScroll=()=>{if(window.scrollY>300){banner.classList.add('track-resume-banner--dismissed');setTimeout(()=>banner.remove(),300);window.removeEventListener('scroll',dismissOnScroll);}};window.addEventListener('scroll',dismissOnScroll,{passive:true});}
function initTracks(){trackNav=document.querySelector(SELECTORS.trackNav);if(!trackNav)return;trackId=trackNav.getAttribute('data-track-id')||window.location.pathname;trackSections=Array.from(document.querySelectorAll(SELECTORS.sectionTarget));sidebarLinks=Array.from(trackNav.querySelectorAll(SELECTORS.trackSection));tocSidebar=document.querySelector(SELECTORS.tocSidebar);tocGroups=tocSidebar?Array.from(tocSidebar.querySelectorAll(SELECTORS.tocGroup)):[];if(!trackSections.length)return;loadProgress();restoreVisitedState();trackNav.setAttribute('data-enhanced','true');scrollHandler=throttleScroll(updateCurrentSection);window.addEventListener('scroll',scrollHandler,{passive:true});updateCurrentSection();setTimeout(checkResume,500);sidebarLinks.forEach((link,index)=>{link.addEventListener('click',()=>{currentSectionIndex=-1;setTimeout(updateCurrentSection,100);});});}
function cleanup(){if(scrollHandler){window.removeEventListener('scroll',scrollHandler);scrollHandler=null;}
if(trackNav){trackNav.removeAttribute('data-enhanced');}
if(announceTimeout){clearTimeout(announceTimeout);}}
function resetProgress(){progress={visited:[],lastSection:0};saveProgress();sidebarLinks.forEach(link=>{link.removeAttribute('data-track-visited');link.removeAttribute('data-track-completed');});}
ready(initTracks);window.addEventListener('contentLoaded',initTracks);if(window.Bengal&&window.Bengal.enhance){window.Bengal.enhance.register('track-nav',function(el){});}
window.BengalTracks={init:initTracks,cleanup:cleanup,resetProgress:resetProgress,getCurrentSection:()=>currentSectionIndex,getProgress:()=>({...progress})};})();