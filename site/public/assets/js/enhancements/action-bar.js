(function(){'use strict';if(!window.BengalUtils){console.error('BengalUtils not loaded - action-bar.js requires utils.js');return;}
const{log,copyToClipboard,ready}=window.BengalUtils;ready(init);function init(){initPopoverPositioning();initCopyActions();initAIShareActions();updateShareLinks();}
function initPopoverPositioning(){const triggers=document.querySelectorAll('[popovertarget]');triggers.forEach(trigger=>{const targetId=trigger.getAttribute('popovertarget');const popover=document.getElementById(targetId);if(!popover)return;popover.addEventListener('toggle',(e)=>{if(e.newState==='open'){positionPopover(trigger,popover);}});const chevron=trigger.querySelector('[class*="chevron"]');if(chevron){popover.addEventListener('toggle',(e)=>{if(e.newState==='open'){chevron.style.transform='rotate(180deg)';}else{chevron.style.transform='rotate(0deg)';}});}});}
function positionPopover(trigger,popover){const rect=trigger.getBoundingClientRect();const popoverRect=popover.getBoundingClientRect();let top=rect.bottom+8;let left=rect.right-popoverRect.width;if(left<8){left=8;}
const rightOverflow=left+popoverRect.width-window.innerWidth+8;if(rightOverflow>0){left-=rightOverflow;}
if(top+popoverRect.height>window.innerHeight-8){top=rect.top-popoverRect.height-8;}
popover.style.top=`${top}px`;popover.style.left=`${left}px`;}
function initCopyActions(){document.addEventListener('click',async(e)=>{const button=e.target.closest('[data-action^="copy"]');if(!button)return;e.preventDefault();await handleCopyAction(button);});}
function initAIShareActions(){document.addEventListener('click',async(e)=>{const aiLink=e.target.closest('[data-ai]');if(!aiLink)return;e.preventDefault();await handleAIShare(aiLink);});}
async function handleAIShare(link){const aiName=link.getAttribute('data-ai');const originalHref=link.getAttribute('href');const urlMatch=originalHref.match(/index\.txt/);if(!urlMatch){window.open(originalHref,'_blank','noopener,noreferrer');return;}
const popover=link.closest('[popover]');const copyLlmBtn=popover?.querySelector('[data-action="copy-llm-txt"]');if(!copyLlmBtn){window.open(originalHref,'_blank','noopener,noreferrer');return;}
const llmTxtUrl=copyLlmBtn.getAttribute('data-url');const originalHTML=link.innerHTML;link.innerHTML=`<svg class="spinning"fill="none"stroke="currentColor"viewBox="0 0 24 24"><path stroke-linecap="round"stroke-linejoin="round"stroke-width="2"
d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg><span>Loading...</span>`;try{const controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),5000);const response=await fetch(llmTxtUrl,{signal:controller.signal});clearTimeout(timeoutId);if(!response.ok)throw new Error(`HTTP ${response.status}`);const content=await response.text();await copyToClipboard(content);const fullUrl=toAbsoluteUrl(llmTxtUrl);const aiPrompt='I have documentation content from '+fullUrl+' copied to my clipboard. Please help me understand it.';const aiUrl=buildAIUrl(aiName,aiPrompt);link.innerHTML=`<svg fill="none"stroke="currentColor"viewBox="0 0 24 24"><path stroke-linecap="round"stroke-linejoin="round"stroke-width="2"
d="M5 13l4 4L19 7"/></svg><span>Copied!Opening...</span>`;setTimeout(()=>{link.innerHTML=originalHTML;popover?.hidePopover?.();window.open(aiUrl,'_blank','noopener,noreferrer');},500);}catch(error){log('AI share failed:',error);link.innerHTML=originalHTML;const errorSpan=document.createElement('span');errorSpan.style.cssText='color: var(--color-warning); font-size: 0.75rem; display: block;';errorSpan.textContent='Could not load content. Opening with URL only...';link.appendChild(errorSpan);setTimeout(()=>{link.innerHTML=originalHTML;popover?.hidePopover?.();window.open(originalHref,'_blank','noopener,noreferrer');},1500);}}
function buildAIUrl(aiName,prompt){const encodedPrompt=encodeURIComponent(prompt);const baseUrls={'claude':'https:'+'//claude.ai/new?q=','chatgpt':'https:'+'//chatgpt.com/?q=','gemini':'https:'+'//gemini.google.com/app?q=','copilot':'https:'+'//copilot.microsoft.com/?q='};const baseUrl=baseUrls[aiName]||baseUrls['claude'];return baseUrl+encodedPrompt;}
function updateShareLinks(){const aiLinks=document.querySelectorAll('.action-bar-share-ai, .page-hero__share-ai');aiLinks.forEach(link=>{const href=link.getAttribute('href');if(!href)return;try{const url=new URL(href);const params=new URLSearchParams(url.search);const q=params.get('q');if(q){const relativeMatch=q.match(/(^|\s)(\/?[^:\s]*index\.txt)/);if(relativeMatch&&relativeMatch[2]&&!relativeMatch[2].startsWith('http')){const relativePath=relativeMatch[2];const absolutePath=toAbsoluteUrl(relativePath);const newQ=q.replace(relativePath,absolutePath);params.set('q',newQ);url.search=params.toString();link.setAttribute('href',url.toString());}}}catch(e){}});}
function toAbsoluteUrl(relativeUrl){if(!relativeUrl){return window.location.href;}
if(relativeUrl.startsWith('http://')||relativeUrl.startsWith('https://')){return relativeUrl;}
return window.location.origin+relativeUrl;}
async function handleCopyAction(button){const action=button.getAttribute('data-action');const url=button.getAttribute('data-url');if(!url){log('Copy action missing data-url attribute');showError(button,'URL missing');return;}
try{let textToCopy='';switch(action){case'copy-url':textToCopy=toAbsoluteUrl(url);await copyToClipboard(textToCopy);showSuccess(button,'URL copied!');break;case'copy-llm-txt':const controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),5000);try{const response=await fetch(url,{signal:controller.signal});clearTimeout(timeoutId);if(!response.ok)throw new Error(`HTTP ${response.status}`);textToCopy=await response.text();await copyToClipboard(textToCopy);showSuccess(button,'LLM text copied!');}catch(fetchError){clearTimeout(timeoutId);if(fetchError.name==='AbortError'){throw new Error('Request timed out');}
throw fetchError;}
break;default:log('Unknown copy action:',action);}}catch(error){log('Copy failed:',error);showError(button,'Copy failed');}}
function showSuccess(button,message){const originalHTML=button.innerHTML;button.classList.add('success');button.innerHTML=`<svg fill="none"stroke="currentColor"viewBox="0 0 24 24"><path stroke-linecap="round"stroke-linejoin="round"stroke-width="2"
d="M5 13l4 4L19 7"/></svg><span>${message}</span>`;setTimeout(()=>{button.classList.remove('success');button.innerHTML=originalHTML;},2000);}
function showError(button,message){const originalHTML=button.innerHTML;button.innerHTML=`<svg fill="none"stroke="currentColor"viewBox="0 0 24 24"><path stroke-linecap="round"stroke-linejoin="round"stroke-width="2"
d="M6 18L18 6M6 6l12 12"/></svg><span>${message}</span>`;setTimeout(()=>{button.innerHTML=originalHTML;},2000);}})();