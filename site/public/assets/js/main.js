(function(){'use strict';if(!window.BengalUtils){console.error('[Bengal] BengalUtils not loaded - main.js requires utils.js');window.BengalUtils={log:()=>{},copyToClipboard:async()=>{},isExternalUrl:()=>false,ready:(fn)=>{if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',fn);}else{fn();}}};}
const log=window.BengalUtils?.log||(()=>{});const copyToClipboard=window.BengalUtils?.copyToClipboard||(async()=>{});const isExternalUrl=window.BengalUtils?.isExternalUrl||(()=>false);const ready=window.BengalUtils?.ready||((fn)=>{if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',fn);}else{fn();}});function setupSmoothScroll(){if(typeof document==='undefined'){log('[Bengal] Document not available for setupSmoothScroll');return;}
const anchors=document.querySelectorAll('a[href^="#"]');if(!anchors||anchors.length===0){return;}
anchors.forEach(function(anchor){if(!anchor||typeof anchor.addEventListener!=='function'){return;}
anchor.addEventListener('click',function(e){const href=this.getAttribute('href');if(href==='#'){return;}
const id=href.substring(1);const target=document.getElementById(id);if(target){e.preventDefault();target.scrollIntoView({behavior:'smooth',block:'start'});history.pushState(null,null,href);target.focus({preventScroll:true});}});});}
function setupExternalLinks(){const links=document.querySelectorAll('a[href]');links.forEach(function(link){const href=link.getAttribute('href');if(!href||href.startsWith('#')||href.startsWith('mailto:')||href.startsWith('tel:')){return;}
if(isExternalUrl(href)){link.setAttribute('data-external','true');link.setAttribute('rel','noopener noreferrer');link.setAttribute('target','_blank');link.setAttribute('aria-label',link.textContent+' (opens in new tab)');}});}
function setupCodeCopyButtons(){const codeBlocks=document.querySelectorAll('pre code');codeBlocks.forEach(function(codeBlock){const pre=codeBlock.parentElement;if(pre.closest('.code-block-wrapper')||pre.querySelector('.code-copy-button')){return;}
const highlightTable=pre.closest('.highlighttable');const isTableLayout=!!highlightTable;let language='';const classList=codeBlock.className;const matches=classList.match(/language-(\w+)|hljs-(\w+)/);if(matches){language=(matches[1]||matches[2]).toUpperCase();}
const button=document.createElement('button');button.className='code-copy-button';button.setAttribute('aria-label','Copy');button.innerHTML=`<svg width="16"height="16"viewBox="0 0 24 24"fill="none"stroke="currentColor"stroke-width="2"><rect x="9"y="9"width="13"height="13"rx="2"ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg><span>Copy</span>`;if(isTableLayout){const highlightWrapper=highlightTable.closest('.highlight');if(highlightWrapper){highlightWrapper.classList.add('has-copy-button');button.classList.add('code-copy-button--absolute');highlightWrapper.appendChild(button);}}else{const header=document.createElement('div');header.className='code-header-inline';if(language){const langLabel=document.createElement('span');langLabel.className='code-language';langLabel.textContent=language;header.appendChild(langLabel);}else{header.appendChild(document.createElement('span'));}
header.appendChild(button);const wrapper=document.createElement('div');wrapper.className='code-block-wrapper';const borderClasses=['gradient-border','gradient-border-subtle','gradient-border-strong','fluid-border','fluid-combined'];borderClasses.forEach(function(cls){if(pre.classList.contains(cls)){pre.classList.remove(cls);wrapper.classList.add(cls);}});pre.parentNode.insertBefore(wrapper,pre);wrapper.appendChild(pre);wrapper.appendChild(header);}
button.addEventListener('click',function(e){e.preventDefault();const code=codeBlock.textContent;copyToClipboard(code).then(function(){button.innerHTML=`<svg width="16"height="16"viewBox="0 0 24 24"fill="none"stroke="currentColor"stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg><span>Copied!</span>`;button.classList.add('copied');button.setAttribute('aria-label','Code copied!');setTimeout(function(){button.innerHTML=`<svg width="16"height="16"viewBox="0 0 24 24"fill="none"stroke="currentColor"stroke-width="2"><rect x="9"y="9"width="13"height="13"rx="2"ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg><span>Copy</span>`;button.classList.remove('copied');button.setAttribute('aria-label','Copy');},2000);}).catch(function(err){log('Failed to copy code:',err);button.setAttribute('aria-label','Failed to copy');setTimeout(function(){button.innerHTML=`<svg width="16"height="16"viewBox="0 0 24 24"fill="none"stroke="currentColor"stroke-width="2"><rect x="9"y="9"width="13"height="13"rx="2"ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg><span>Copy</span>`;button.setAttribute('aria-label','Copy');},2000);});});});}
let imageObserver=null;let trackScrollHandler=null;function setupLazyLoading(){if('IntersectionObserver'in window){imageObserver=new IntersectionObserver(function(entries){entries.forEach(function(entry){if(entry.isIntersecting){const img=entry.target;if(img.dataset.src){img.src=img.dataset.src;img.removeAttribute('data-src');}
if(imageObserver){imageObserver.unobserve(img);}}});});document.querySelectorAll('img[data-src]').forEach(function(img){if(imageObserver){imageObserver.observe(img);}});}else{document.querySelectorAll('img[data-src]').forEach(function(img){img.src=img.dataset.src;});}}
function setupKeyboardDetection(){document.addEventListener('keydown',function(e){if(e.key==='Tab'){document.body.classList.add('user-is-tabbing');}});document.addEventListener('mousedown',function(){document.body.classList.remove('user-is-tabbing');});}
function setupScrollAnimations(){if(!CSS.supports('animation-timeline','scroll()')){const animatedElements=document.querySelectorAll('.stagger-fade-in > *');if(animatedElements.length===0)return;if('IntersectionObserver'in window){const observer=new IntersectionObserver(function(entries){entries.forEach(function(entry){if(entry.isIntersecting){entry.target.classList.add('is-visible');observer.unobserve(entry.target);}});},{rootMargin:'0px 0px -50px 0px',threshold:0.1});animatedElements.forEach(function(element){observer.observe(element);});}else{animatedElements.forEach(function(element){element.classList.add('is-visible');});}}}
function setupTrackProgress(){const progressBar=document.getElementById('track-progress-bar');if(!progressBar){return;}
const trackSections=document.querySelectorAll('.track-section');if(trackSections.length===0){return;}
const navLinks=document.querySelectorAll('.track-progress-nav-link');let currentActiveSection=null;function updateProgress(){const windowHeight=window.innerHeight;const documentHeight=document.documentElement.scrollHeight;const scrollTop=window.pageYOffset||document.documentElement.scrollTop;const scrollableHeight=documentHeight-windowHeight;const progress=scrollableHeight>0?Math.min(100,Math.max(0,(scrollTop/scrollableHeight)*100)):0;progressBar.style.width=progress+'%';progressBar.setAttribute('aria-valuenow',Math.round(progress));updateActiveSection();}
function updateActiveSection(){const viewportOffset=150;let activeSection=null;for(let i=trackSections.length-1;i>=0;i--){const section=trackSections[i];const rect=section.getBoundingClientRect();if(rect.top<=viewportOffset){activeSection=section.id;break;}}
if(!activeSection&&trackSections.length>0){activeSection=trackSections[0].id;}
if(activeSection!==currentActiveSection){currentActiveSection=activeSection;navLinks.forEach(function(link){const isActive=link.getAttribute('href')==='#'+activeSection;if(isActive){link.classList.add('active');}else{link.classList.remove('active');}});}}
let ticking=false;trackScrollHandler=function onScroll(){if(!ticking){window.requestAnimationFrame(function(){updateProgress();ticking=false;});ticking=true;}};window.addEventListener('scroll',trackScrollHandler,{passive:true});updateProgress();}
function init(){cleanup();setupSmoothScroll();setupExternalLinks();setupCodeCopyButtons();setupLazyLoading();setupKeyboardDetection();setupScrollAnimations();setupTrackProgress();log('Bengal theme initialized');}
function cleanup(){if(imageObserver){imageObserver.disconnect();imageObserver=null;}
if(trackScrollHandler){window.removeEventListener('scroll',trackScrollHandler);trackScrollHandler=null;}}
ready(init);window.addEventListener('beforeunload',cleanup);window.BengalMain={cleanup:cleanup};})();