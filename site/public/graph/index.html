<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Graph - Rosettes</title>

    <!-- Include theme CSS - absolute path with baseurl support -->
    <link rel="stylesheet" href="/assets/css/style.css">

    <!-- Theme configuration defaults -->
    <script>
        window.BENGAL_THEME_DEFAULTS = {
            appearance: 'system',
            palette: ''
        };
    </script>

    <!-- Theme & Palette initialization - INLINED to prevent FOUC (must be synchronous) -->
    <script>
        (function () {
            try {
                var defaults = window.BENGAL_THEME_DEFAULTS || { appearance: 'system', palette: '' };
                var defaultAppearance = defaults.appearance;
                if (defaultAppearance === 'system') {
                    defaultAppearance = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)
                        ? 'dark' : 'light';
                }
                var storedTheme = localStorage.getItem('bengal-theme');
                var storedPalette = localStorage.getItem('bengal-palette');
                var theme = storedTheme ? (storedTheme === 'system' ? defaultAppearance : storedTheme) : defaultAppearance;
                var palette = storedPalette ?? defaults.palette;
                document.documentElement.setAttribute('data-theme', theme);
                if (palette) { document.documentElement.setAttribute('data-palette', palette); }
            } catch (e) { document.documentElement.setAttribute('data-theme', 'light'); }
        })();
    </script>

    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body class="graph-body">
    <div id="container" class="graph-container">
        <div class="graph-controls">
            <h2>Knowledge Graph</h2>
            <input
                type="text"
                id="search"
                placeholder="Search pages or tags..."
                autocomplete="off"
            />
            <div class="graph-filter-group">
                <label>Filter by Type:</label>
                <select id="filter-type">
                    <option value="all">All Pages</option>
                    <option value="hub">Hubs Only</option>
                    <option value="orphan">Orphans Only</option>
                    <option value="regular">Regular Pages</option>
                </select>
            </div>
            <div class="graph-stats">
                <p><strong>Pages:</strong> 30</p>
                <p><strong>Links:</strong> 45</p>
                <p><strong>Hubs:</strong> 0</p>
                <p><strong>Orphans:</strong> 37</p>
            </div>
        </div>

        <div class="graph-legend">
            <h3>Legend</h3>
            <div class="graph-legend-item">
                <div class="graph-legend-color" style="background: var(--graph-node-hub);"></div>
                <span>Hub (highly connected)</span>
            </div>
            <div class="graph-legend-item">
                <div class="graph-legend-color" style="background: var(--graph-node-regular);"></div>
                <span>Regular page</span>
            </div>
            <div class="graph-legend-item">
                <div class="graph-legend-color" style="background: var(--graph-node-orphan);"></div>
                <span>Orphan (no incoming links)</span>
            </div>
            <div class="graph-legend-item">
                <div class="graph-legend-color" style="background: var(--graph-node-generated);"></div>
                <span>Generated page</span>
            </div>
        </div>

        <div id="graph" class="graph-svg"></div>
        <div class="graph-tooltip" id="tooltip"></div>
    </div>

    <script>
        // Graph data (sort_keys=True for deterministic output)
        const graphData = {
  "edges": [
    {
      "source": "6906473773664142929",
      "target": "6850105790164573809",
      "weight": 2
    },
    {
      "source": "6906473773664142929",
      "target": "-7244252348580726750",
      "weight": 1
    },
    {
      "source": "6906473773664142929",
      "target": "8660230327628514180",
      "weight": 1
    },
    {
      "source": "6906473773664142929",
      "target": "-8394151012272594714",
      "weight": 1
    },
    {
      "source": "6906473773664142929",
      "target": "3146124063214178861",
      "weight": 1
    },
    {
      "source": "6850105790164573809",
      "target": "8660230327628514180",
      "weight": 2
    },
    {
      "source": "-7244252348580726750",
      "target": "-678809353069934221",
      "weight": 2
    },
    {
      "source": "-7244252348580726750",
      "target": "3146124063214178861",
      "weight": 2
    },
    {
      "source": "-7244252348580726750",
      "target": "-5340775064317139517",
      "weight": 2
    },
    {
      "source": "-7244252348580726750",
      "target": "-8394151012272594714",
      "weight": 2
    },
    {
      "source": "3146124063214178861",
      "target": "8660230327628514180",
      "weight": 2
    },
    {
      "source": "3146124063214178861",
      "target": "-106756179683539329",
      "weight": 2
    },
    {
      "source": "8959327404264249969",
      "target": "7983002193751202743",
      "weight": 2
    },
    {
      "source": "-3720440628856263042",
      "target": "-5793673097107169744",
      "weight": 2
    },
    {
      "source": "-3720440628856263042",
      "target": "-2431363867897208233",
      "weight": 1
    },
    {
      "source": "-2431363867897208233",
      "target": "-5793673097107169744",
      "weight": 2
    },
    {
      "source": "-2680059364504895038",
      "target": "-6014002478458981531",
      "weight": 2
    },
    {
      "source": "-2680059364504895038",
      "target": "2091112251267089877",
      "weight": 2
    },
    {
      "source": "-2680059364504895038",
      "target": "4241832673428245673",
      "weight": 2
    },
    {
      "source": "-2680059364504895038",
      "target": "2744152432949460445",
      "weight": 2
    },
    {
      "source": "-2680059364504895038",
      "target": "-106756179683539329",
      "weight": 1
    },
    {
      "source": "-6014002478458981531",
      "target": "2091112251267089877",
      "weight": 1
    },
    {
      "source": "-6014002478458981531",
      "target": "4241832673428245673",
      "weight": 2
    },
    {
      "source": "-6014002478458981531",
      "target": "2744152432949460445",
      "weight": 1
    },
    {
      "source": "-6014002478458981531",
      "target": "-106756179683539329",
      "weight": 2
    },
    {
      "source": "4241832673428245673",
      "target": "-106756179683539329",
      "weight": 2
    },
    {
      "source": "2091112251267089877",
      "target": "-3736415934078126191",
      "weight": 2
    },
    {
      "source": "2091112251267089877",
      "target": "-8259593056738023788",
      "weight": 2
    },
    {
      "source": "2091112251267089877",
      "target": "-6916302928838581689",
      "weight": 2
    },
    {
      "source": "2091112251267089877",
      "target": "2744152432949460445",
      "weight": 2
    },
    {
      "source": "2744152432949460445",
      "target": "-3736415934078126191",
      "weight": 2
    },
    {
      "source": "2744152432949460445",
      "target": "-8259593056738023788",
      "weight": 2
    },
    {
      "source": "2744152432949460445",
      "target": "-6916302928838581689",
      "weight": 2
    },
    {
      "source": "-3736415934078126191",
      "target": "-8259593056738023788",
      "weight": 2
    },
    {
      "source": "-3736415934078126191",
      "target": "-6916302928838581689",
      "weight": 2
    },
    {
      "source": "-6916302928838581689",
      "target": "-8259593056738023788",
      "weight": 2
    },
    {
      "source": "-8232999895001367158",
      "target": "-2747038378329072815",
      "weight": 2
    },
    {
      "source": "-8232999895001367158",
      "target": "-678809353069934221",
      "weight": 2
    },
    {
      "source": "-8232999895001367158",
      "target": "-3422891011620497449",
      "weight": 2
    },
    {
      "source": "-2747038378329072815",
      "target": "-678809353069934221",
      "weight": 2
    },
    {
      "source": "-2747038378329072815",
      "target": "-3422891011620497449",
      "weight": 2
    },
    {
      "source": "-3422891011620497449",
      "target": "-678809353069934221",
      "weight": 2
    },
    {
      "source": "-678809353069934221",
      "target": "-5340775064317139517",
      "weight": 2
    },
    {
      "source": "3445525177282725641",
      "target": "-5340775064317139517",
      "weight": 1
    },
    {
      "source": "4495448781673924098",
      "target": "-6004664436495969082",
      "weight": 1
    }
  ],
  "nodes": [
    {
      "color": "var(--graph-node-orphan)",
      "connectivity": 0,
      "id": "6382984564784364971",
      "incoming_refs": 0,
      "label": "Rosettes",
      "outgoing_refs": 0,
      "reading_time": 1,
      "size": 8.8,
      "tags": [],
      "type": "orphan",
      "url": "/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 8,
      "id": "6906473773664142929",
      "incoming_refs": 3,
      "label": "About",
      "outgoing_refs": 5,
      "reading_time": 1,
      "size": 20.8,
      "tags": [
        "about",
        "architecture"
      ],
      "type": "regular",
      "url": "/docs/about/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 5,
      "id": "6850105790164573809",
      "incoming_refs": 3,
      "label": "Architecture",
      "outgoing_refs": 2,
      "reading_time": 3,
      "size": 17.9,
      "tags": [
        "architecture",
        "design"
      ],
      "type": "regular",
      "url": "/docs/about/architecture/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 9,
      "id": "-7244252348580726750",
      "incoming_refs": 5,
      "label": "Rosettes vs Pygments",
      "outgoing_refs": 4,
      "reading_time": 4,
      "size": 24.7,
      "tags": [
        "comparison",
        "pygments"
      ],
      "type": "regular",
      "url": "/docs/about/comparison/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 2,
      "id": "-8394151012272594714",
      "incoming_refs": 1,
      "label": "FAQ",
      "outgoing_refs": 1,
      "reading_time": 3,
      "size": 13.4,
      "tags": [
        "faq"
      ],
      "type": "regular",
      "url": "/docs/about/faq/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 7,
      "id": "3146124063214178861",
      "incoming_refs": 4,
      "label": "Performance",
      "outgoing_refs": 3,
      "reading_time": 3,
      "size": 20.9,
      "tags": [
        "performance",
        "benchmarks"
      ],
      "type": "regular",
      "url": "/docs/about/performance/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 5,
      "id": "8660230327628514180",
      "incoming_refs": 3,
      "label": "Thread Safety",
      "outgoing_refs": 2,
      "reading_time": 3,
      "size": 17.9,
      "tags": [
        "threading",
        "safety"
      ],
      "type": "regular",
      "url": "/docs/about/thread-safety/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 4,
      "id": "8959327404264249969",
      "incoming_refs": 3,
      "label": "Extending",
      "outgoing_refs": 1,
      "reading_time": 1,
      "size": 14.8,
      "tags": [
        "extending",
        "customization"
      ],
      "type": "regular",
      "url": "/docs/extending/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 4,
      "id": "7983002193751202743",
      "incoming_refs": 3,
      "label": "Custom Formatter",
      "outgoing_refs": 1,
      "reading_time": 2,
      "size": 15.6,
      "tags": [
        "formatter",
        "customization"
      ],
      "type": "regular",
      "url": "/docs/extending/custom-formatter/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 5,
      "id": "-3720440628856263042",
      "incoming_refs": 3,
      "label": "Get Started",
      "outgoing_refs": 2,
      "reading_time": 1,
      "size": 16.3,
      "tags": [
        "onboarding",
        "quickstart"
      ],
      "type": "regular",
      "url": "/docs/get-started/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 2,
      "id": "-2431363867897208233",
      "incoming_refs": 1,
      "label": "Installation",
      "outgoing_refs": 1,
      "reading_time": 1,
      "size": 11.8,
      "tags": [
        "installation"
      ],
      "type": "regular",
      "url": "/docs/get-started/installation/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 5,
      "id": "-5793673097107169744",
      "incoming_refs": 3,
      "label": "Quickstart",
      "outgoing_refs": 2,
      "reading_time": 1,
      "size": 16.3,
      "tags": [
        "quickstart",
        "tutorial"
      ],
      "type": "regular",
      "url": "/docs/get-started/quickstart/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 11,
      "id": "-2680059364504895038",
      "incoming_refs": 6,
      "label": "Highlighting",
      "outgoing_refs": 5,
      "reading_time": 1,
      "size": 25.3,
      "tags": [
        "highlighting",
        "api"
      ],
      "type": "regular",
      "url": "/docs/highlighting/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 9,
      "id": "-6014002478458981531",
      "incoming_refs": 4,
      "label": "Basic Usage",
      "outgoing_refs": 5,
      "reading_time": 2,
      "size": 23.1,
      "tags": [
        "highlighting",
        "api"
      ],
      "type": "regular",
      "url": "/docs/highlighting/basic-usage/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 7,
      "id": "4241832673428245673",
      "incoming_refs": 4,
      "label": "Line Highlighting",
      "outgoing_refs": 3,
      "reading_time": 2,
      "size": 20.1,
      "tags": [
        "highlighting",
        "lines"
      ],
      "type": "regular",
      "url": "/docs/highlighting/line-highlighting/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 7,
      "id": "-106756179683539329",
      "incoming_refs": 4,
      "label": "Parallel Processing",
      "outgoing_refs": 3,
      "reading_time": 2,
      "size": 20.1,
      "tags": [
        "parallel",
        "performance"
      ],
      "type": "regular",
      "url": "/docs/highlighting/parallel/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 13,
      "id": "2091112251267089877",
      "incoming_refs": 8,
      "label": "Reference",
      "outgoing_refs": 5,
      "reading_time": 1,
      "size": 28.3,
      "tags": [
        "reference",
        "api"
      ],
      "type": "regular",
      "url": "/docs/reference/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 13,
      "id": "2744152432949460445",
      "incoming_refs": 8,
      "label": "API Reference",
      "outgoing_refs": 5,
      "reading_time": 5,
      "size": 31.5,
      "tags": [
        "api",
        "reference"
      ],
      "type": "regular",
      "url": "/docs/reference/api/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 10,
      "id": "-3736415934078126191",
      "incoming_refs": 6,
      "label": "Configuration",
      "outgoing_refs": 4,
      "reading_time": 2,
      "size": 24.6,
      "tags": [
        "configuration",
        "reference"
      ],
      "type": "regular",
      "url": "/docs/reference/configuration/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 11,
      "id": "-6916302928838581689",
      "incoming_refs": 7,
      "label": "Supported Languages",
      "outgoing_refs": 4,
      "reading_time": 4,
      "size": 27.7,
      "tags": [
        "languages",
        "reference"
      ],
      "type": "regular",
      "url": "/docs/reference/languages/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 11,
      "id": "-8259593056738023788",
      "incoming_refs": 7,
      "label": "Token Types",
      "outgoing_refs": 4,
      "reading_time": 5,
      "size": 28.5,
      "tags": [
        "tokens",
        "reference"
      ],
      "type": "regular",
      "url": "/docs/reference/token-types/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 9,
      "id": "-8232999895001367158",
      "incoming_refs": 6,
      "label": "Styling",
      "outgoing_refs": 3,
      "reading_time": 1,
      "size": 22.3,
      "tags": [
        "styling",
        "css",
        "themes"
      ],
      "type": "regular",
      "url": "/docs/styling/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 7,
      "id": "-2747038378329072815",
      "incoming_refs": 4,
      "label": "CSS Classes",
      "outgoing_refs": 3,
      "reading_time": 3,
      "size": 20.9,
      "tags": [
        "css",
        "classes"
      ],
      "type": "regular",
      "url": "/docs/styling/css-classes/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 8,
      "id": "-3422891011620497449",
      "incoming_refs": 5,
      "label": "Custom Themes",
      "outgoing_refs": 3,
      "reading_time": 2,
      "size": 21.6,
      "tags": [
        "themes",
        "css"
      ],
      "type": "regular",
      "url": "/docs/styling/custom-themes/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 12,
      "id": "-678809353069934221",
      "incoming_refs": 7,
      "label": "Pygments Themes",
      "outgoing_refs": 5,
      "reading_time": 2,
      "size": 27.6,
      "tags": [
        "pygments",
        "themes"
      ],
      "type": "regular",
      "url": "/docs/styling/pygments-themes/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 2,
      "id": "3445525177282725641",
      "incoming_refs": 1,
      "label": "Tutorials",
      "outgoing_refs": 1,
      "reading_time": 1,
      "size": 11.8,
      "tags": [
        "tutorials"
      ],
      "type": "regular",
      "url": "/docs/tutorials/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 6,
      "id": "-5340775064317139517",
      "incoming_refs": 4,
      "label": "Migrate from Pygments",
      "outgoing_refs": 2,
      "reading_time": 3,
      "size": 19.4,
      "tags": [
        "migration",
        "pygments"
      ],
      "type": "regular",
      "url": "/docs/tutorials/migrate-from-pygments/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 1,
      "id": "2401548206048339579",
      "incoming_refs": 1,
      "label": "Documentation",
      "outgoing_refs": 0,
      "reading_time": 1,
      "size": 10.3,
      "tags": [
        "documentation"
      ],
      "type": "regular",
      "url": "/docs/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 1,
      "id": "-6004664436495969082",
      "incoming_refs": 1,
      "label": "v0.3.0",
      "outgoing_refs": 0,
      "reading_time": 2,
      "size": 11.1,
      "tags": [
        "release"
      ],
      "type": "regular",
      "url": "/releases/0.3.0/"
    },
    {
      "color": "var(--graph-node-regular)",
      "connectivity": 3,
      "id": "4495448781673924098",
      "incoming_refs": 2,
      "label": "Releases",
      "outgoing_refs": 1,
      "reading_time": 1,
      "size": 13.3,
      "tags": [
        "releases",
        "changelog"
      ],
      "type": "regular",
      "url": "/releases/"
    }
  ],
  "stats": {
    "hubs": 0,
    "orphans": 37,
    "total_links": 45,
    "total_pages": 30
  }
};

        // Dimensions
        const width = window.innerWidth;
        const height = window.innerHeight;

        // Create SVG
        const svg = d3.select("#graph")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        // Add zoom behavior
        const g = svg.append("g");

        svg.call(d3.zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            })
        );

        // Helper function to resolve CSS variables to actual colors
        function resolveCSSVariable(varName) {
            const cleanVar = varName.replace(/var\(|\s|\)/g, '');
            const root = document.documentElement;
            const value = getComputedStyle(root).getPropertyValue(cleanVar).trim();
            return value || '#9e9e9e';
        }

        // Map node types to graph-specific CSS variables
        const nodeTypeColorMap = {
            'hub': '--graph-node-hub',
            'regular': '--graph-node-regular',
            'orphan': '--graph-node-orphan',
            'generated': '--graph-node-generated'
        };

        // Resolve colors before rendering
        graphData.nodes.forEach(node => {
            const cssVar = nodeTypeColorMap[node.type] || '--graph-node-regular';
            node.color = resolveCSSVariable(cssVar);
        });

        // Resolve link color
        const linkColor = resolveCSSVariable('--graph-link-color') || 'rgba(100, 100, 100, 0.2)';
        const linkHighlightColor = resolveCSSVariable('--graph-link-highlight') || 'rgba(255, 180, 100, 0.7)';

        // Create force simulation and PRE-COMPUTE positions before rendering
        //
        // Philosophy: Let LINKS define structure, use collision only to prevent overlap
        // - No charge/repulsion - that tears connected nodes apart
        // - Link strength scaled by connectivity - hubs pull harder, become cluster centers
        // - Collision prevents overlap without pushing clusters apart

        // Build node lookup for link strength calculation
        const nodeById = new Map(graphData.nodes.map(n => [n.id, n]));

        const simulation = d3.forceSimulation(graphData.nodes)
            .force("link", d3.forceLink(graphData.edges)
                .id(d => d.id)
                .distance(d => {
                    // Bidirectional links (weight=2) are closer
                    return d.weight === 2 ? 60 : 100;
                })
                .strength(d => {
                    // Bidirectional links pull harder
                    return d.weight === 2 ? 1.5 : 0.8;
                }))
            .force("charge", d3.forceManyBody()
                .strength(-200)       // More repulsion for spacing
                .distanceMax(400))    // Affects further nodes
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide()
                .radius(d => d.size + 12)
                .strength(0.8))

        // Pre-compute 85% of layout (run simulation synchronously)
        const totalIterations = Math.ceil(Math.log(simulation.alphaMin()) / Math.log(1 - simulation.alphaDecay()));
        const precomputeIterations = Math.floor(totalIterations * 0.85);
        for (let i = 0; i < precomputeIterations; i++) {
            simulation.tick();
        }

        // Render with mostly-computed positions - links first (behind nodes)
        const link = g.append("g")
            .attr("class", "graph-links")
            .selectAll("line")
            .data(graphData.edges)
            .enter().append("line")
            .attr("class", "graph-link")
            .attr("stroke", linkColor)
            .attr("stroke-width", 1)
            .attr("stroke-linecap", "round")
            .style("opacity", 0.6)
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

        // Render nodes (on top of links)
        const node = g.append("g")
            .attr("class", "graph-nodes")
            .selectAll("circle")
            .data(graphData.nodes)
            .enter().append("circle")
            .attr("class", d => `graph-node graph-node-${d.type}`)
            .attr("r", d => d.size)
            .attr("fill", d => d.color)
            .attr("cx", d => d.x)
            .attr("cy", d => d.y)
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended))
            .on("click", (event, d) => {
                window.location.href = d.url;
            })
            .on("mouseover", (event, d) => {
                showTooltip(event, d);
                highlightConnections(d);
            })
            .on("mouseout", () => {
                hideTooltip();
                clearHighlights();
            });

        // Setup tick handler for animations and dragging
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);
            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);
        });

        // Very quick settling - barely noticeable snap
        simulation.alphaDecay(0.2).alpha(0.05).restart();

        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Tooltip functions
        const tooltip = d3.select("#tooltip");

        function showTooltip(event, d) {
            const tags = d.tags.length > 0
                ? `<div class="tags">${d.tags.map(t => `<span class="tag">${t}</span>`).join('')}</div>`
                : '';

            tooltip
                .style("display", "block")
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY + 10) + "px")
                .html(`
                    <h4>${d.label}</h4>
                    <p>${d.reading_time} min read Â· ${d.incoming_refs} in / ${d.outgoing_refs} out</p>
                    ${tags}
                `);
        }

        function hideTooltip() {
            tooltip.style("display", "none");
        }

        // Highlight state management
        let currentHighlight = null;
        let clearTimer = null;

        function highlightConnections(d) {
            // Cancel any pending clear
            if (clearTimer) {
                clearTimeout(clearTimer);
                clearTimer = null;
            }

            // Skip if already highlighting this node
            if (currentHighlight === d.id) return;
            currentHighlight = d.id;

            // Find connected node IDs
            const connectedIds = new Set([d.id]);
            graphData.edges.forEach(e => {
                const sourceId = typeof e.source === 'object' ? e.source.id : e.source;
                const targetId = typeof e.target === 'object' ? e.target.id : e.target;
                if (sourceId === d.id) connectedIds.add(targetId);
                if (targetId === d.id) connectedIds.add(sourceId);
            });

            // Animate the fade (smooth transition now that we have debouncing)
            node.transition().duration(150)
                .style("opacity", n => connectedIds.has(n.id) ? 1 : 0.12);

            // Highlight connected links with animation
            link.transition().duration(150)
                .style("opacity", e => {
                    const sourceId = typeof e.source === 'object' ? e.source.id : e.source;
                    const targetId = typeof e.target === 'object' ? e.target.id : e.target;
                    return (sourceId === d.id || targetId === d.id) ? 1 : 0.06;
                })
                .style("stroke-width", e => {
                    const sourceId = typeof e.source === 'object' ? e.source.id : e.source;
                    const targetId = typeof e.target === 'object' ? e.target.id : e.target;
                    return (sourceId === d.id || targetId === d.id) ? 2 : 1;
                });

            link.classed("highlighted", e => {
                const sourceId = typeof e.source === 'object' ? e.source.id : e.source;
                const targetId = typeof e.target === 'object' ? e.target.id : e.target;
                return sourceId === d.id || targetId === d.id;
            });
        }

        function scheduleClearHighlights() {
            // Delay clearing - gives time to move to another node
            if (clearTimer) clearTimeout(clearTimer);
            clearTimer = setTimeout(() => {
                currentHighlight = null;
                node.transition().duration(300).style("opacity", 1);
                link.transition().duration(300)
                    .style("opacity", 0.6)
                    .style("stroke-width", 1);
                link.classed("highlighted", false);
            }, 800);
        }

        function clearHighlights() {
            scheduleClearHighlights();
        }

        // Search and filter functionality
        const searchInput = document.getElementById('search');
        const filterType = document.getElementById('filter-type');

        function updateVisibility() {
            const query = searchInput.value.toLowerCase();
            const filter = filterType.value;

            node.style("opacity", d => {
                // Apply search filter
                const matchesSearch = !query ||
                    d.label.toLowerCase().includes(query) ||
                    d.tags.some(t => t.toLowerCase().includes(query));

                // Apply type filter (use node.type property)
                let matchesType = true;
                if (filter !== 'all') {
                    matchesType = d.type === filter;
                }

                return matchesSearch && matchesType ? 1 : 0.2;
            });

            // Hide links to filtered nodes
            link.style("opacity", d => {
                const sourceVisible = node.filter(n => n.id === (typeof d.source === 'object' ? d.source.id : d.source)).style("opacity") === "1";
                const targetVisible = node.filter(n => n.id === (typeof d.target === 'object' ? d.target.id : d.target)).style("opacity") === "1";
                return sourceVisible && targetVisible ? 1 : 0.1;
            });
        }

        searchInput.addEventListener('input', updateVisibility);
        filterType.addEventListener('change', updateVisibility);

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === '/' || (e.metaKey && e.key === 'k')) {
                e.preventDefault();
                searchInput.focus();
            }
            if (e.key === 'Escape') {
                searchInput.value = '';
                filterType.value = 'all';
                searchInput.blur();
                updateVisibility();
            }
        });
    </script>
</body>
</html>
